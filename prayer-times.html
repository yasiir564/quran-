<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prayer Times Tool - Accurate Salah Timings</title>
    <meta name="description" content="Find accurate Islamic prayer times based on your location. Get Salah timings for Fajr, Dhuhr, Asr, Maghrib, and Isha with this easy-to-use tool.">
    <meta name="keywords" content="Prayer Times, Salah Timings, Islamic Prayer Schedule, Fajr, Dhuhr, Asr, Maghrib, Isha, Muslim Prayer Tool, Ramadan Times, Suhur Time, Iftar Time, Sehri Time, Islamic Calendar, Taraweeh Prayers, Ramadan 2024, Ramadan Fasting, Islamic Fasting, Eid Prayer Timings">
     <link rel="icon" href="/tinywow_Quran pro_62044384.png" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.lordicon.com/lordicon.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.min.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1850217813586802"
     crossorigin="anonymous"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
       :root {
    --gradient-start: #7f1bf2;
    --gradient-end: #9543f5;
    --accent-color: #7f1bf2;
    --accent-dark: #6813d0;
    --card-bg: rgba(255, 255, 255, 0.9);
    --primary-color: #7f1bf2;
}

html {
    scroll-behavior: smooth;
}

body {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    font-family: 'Tajawal', sans-serif;
    overflow-x: hidden;
}

.custom-gradient {
    background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
}

.prayer-time-card {
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    background: var(--card-bg);
    overflow: hidden;
    position: relative;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.prayer-time-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.prayer-time-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 15px 30px rgba(127, 27, 242, 0.25);
}

.prayer-time-card:hover::before {
    opacity: 1;
}

.prayer-time-card.active {
    border: 2px solid var(--accent-color);
    box-shadow: 0 10px 25px rgba(127, 27, 242, 0.3);
}

.prayer-time-card.active::before {
    opacity: 1;
    width: 6px;
}

.arabic {
    font-family: 'Tajawal', sans-serif;
    font-weight: 500;
}

.scrollbar {
    scrollbar-width: thin;
    scrollbar-color: var(--accent-color) rgba(240, 240, 240, 0.7);
}

.scrollbar::-webkit-scrollbar {
    width: 8px;
}

.scrollbar::-webkit-scrollbar-track {
    background: rgba(240, 240, 240, 0.7);
    border-radius: 10px;
}

.scrollbar::-webkit-scrollbar-thumb {
    background: var(--accent-color);
    border-radius: 10px;
}

.countdown {
    font-variant-numeric: tabular-nums;
}

.icon-float {
    animation: float 3s ease-in-out infinite;
    filter: drop-shadow(0 5px 15px rgba(127, 27, 242, 0.3));
}

@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
}

.nav-shine {
    position: relative;
    overflow: hidden;
}

.nav-shine::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        to right,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.3) 50%,
        rgba(255, 255, 255, 0) 100%
    );
    transform: rotate(30deg);
    animation: shine 6s infinite linear;
}

@keyframes shine {
    from { transform: translateX(-100%) rotate(30deg); }
    to { transform: translateX(100%) rotate(30deg); }
}

@media (prefers-reduced-motion) {
    .icon-float, .nav-shine::after {
        animation: none;
    }
}

/* Dark Mode Toggle Animation */
.dark-mode-toggle {
  transition: transform 0.3s ease;
}

.dark-mode-toggle:hover {
  transform: rotate(30deg);
}

.dark-mode .dark-mode-toggle:hover {
  transform: rotate(-30deg);
}

/* Focus states for accessibility */
button:focus, select:focus {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

/* Add prayer color accents for Muslim World League */
.method-mwl .prayer-time-card:nth-child(1) {
  border-top: 3px solid #7f1bf2;
}

.method-mwl .prayer-time-card:nth-child(2) {
  border-top: 3px solid #9543f5;
}

.method-mwl .prayer-time-card:nth-child(3) {
  border-top: 3px solid #7f1bf2;
}

.method-mwl .prayer-time-card:nth-child(4) {
  border-top: 3px solid #9543f5;
}

.method-mwl .prayer-time-card:nth-child(5) {
  border-top: 3px solid #7f1bf2;
}

.method-mwl .prayer-time-card:nth-child(6) {
  border-top: 3px solid #9543f5;
}

/* AdSense Container Styles */
.ad-container {
    width: 100%;
    margin: 1rem 0 2rem 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100px;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 0.5rem;
    overflow: hidden;
    backdrop-filter: blur(5px);
    transition: all 0.3s ease;
    border: 1px solid rgba(127, 27, 242, 0.1);
}

.ad-container ins {
    display: block;
    width: 100%;
    text-align: center;
}

@media (max-width: 768px) {
    .ad-container {
        margin: 1rem 0 1.5rem 0;
    }
}

/* SIDEBAR STYLES */
.sidebar {
    height: 100vh;
    width: 280px;
    position: fixed;
    z-index: 1000;
    top: 0;
    left: -280px;
    background: linear-gradient(135deg, #7f1bf2, #9543f5);
    overflow-x: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    padding-top: 85px;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar.open {
    left: 0;
    box-shadow: 0 0 50px rgba(127, 27, 242, 0.3);
}

.sidebar a {
    padding: 14px 24px;
    text-decoration: none;
    font-size: 16px;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    border-radius: 0 25px 25px 0;
    margin: 4px 0;
    margin-right: 16px;
    font-weight: 500;
}

.sidebar a:hover {
    color: #ffffff;
    background-color: rgba(255, 255, 255, 0.1);
    transform: translateX(8px);
}

.sidebar a.active {
    background-color: rgba(255, 255, 255, 0.2);
    color: #ffffff;
}

.sidebar .closebtn {
    position: absolute;
    top: 20px;
    right: 25px;
    font-size: 28px;
    color: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    margin: 0;
    padding: 0;
}

.sidebar .closebtn:hover {
    background-color: rgba(255, 255, 255, 0.1);
    transform: rotate(90deg);
}

.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 999;
    backdrop-filter: blur(3px);
    transition: all 0.3s ease;
}

.sidebar-overlay.active {
    display: block;
}

.openbtn {
    font-size: 18px;
    cursor: pointer;
    background-color: #7f1bf2;
    color: white;
    padding: 12px 20px;
    border: none;
    position: fixed;
    top: 40px;
    left: 20px;
    z-index: 1000;
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(127, 27, 242, 0.3);
}

.openbtn:hover {
    background-color: #6813d0;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(127, 27, 242, 0.4);
}

#main {
    transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 20px;
}

@media screen and (max-width: 768px) {
    .sidebar {
        width: 100%;
        left: -100%;
    }
    
    .openbtn {
        top: 20px;
        left: 20px;
    }
}

@media screen and (max-height: 450px) {
    .sidebar {
        padding-top: 60px;
    }
    
    .sidebar a {
        font-size: 16px;
        padding: 10px 20px;
    }
}
        /* Benefits Section Styles */
.benefits-section {
    position: relative;
    overflow: hidden;
}

.benefits-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 400px;
    background: linear-gradient(180deg, rgba(127, 27, 242, 0.05) 0%, rgba(255, 255, 255, 0) 100%);
    z-index: -1;
}

.benefits-title {
    background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    display: inline-block;
}

.benefit-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.benefit-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s ease;
}

.benefit-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(127, 27, 242, 0.15);
}

.benefit-card:hover::after {
    transform: scaleX(1);
}

.benefit-icon-wrapper {
    margin-bottom: 1.5rem;
    background: rgba(127, 27, 242, 0.05);
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.benefit-card:hover .benefit-icon-wrapper {
    transform: scale(1.1);
    background: rgba(127, 27, 242, 0.1);
}

.benefit-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #333;
    font-family: 'Tajawal', sans-serif;
    text-align: center;
}

.benefit-description {
    color: #666;
    line-height: 1.6;
    font-size: 1rem;
    text-align: center;
}

/* Dark Mode Styles */
@media (prefers-color-scheme: dark) {
    .benefit-card {
        background: rgba(30, 30, 40, 0.8);
        border-color: rgba(127, 27, 242, 0.2);
    }
    
    .benefit-title {
        color: #fff;
    }
    
    .benefit-description {
        color: #ccc;
    }
    
    .benefits-section::before {
        background: linear-gradient(180deg, rgba(127, 27, 242, 0.1) 0%, rgba(30, 30, 40, 0) 100%);
    }
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .benefit-card {
        padding: 1.5rem;
    }
    
    .benefit-icon-wrapper {
        width: 60px;
        height: 60px;
    }
    
    .benefit-title {
        font-size: 1.1rem;
    }
    
    .benefit-description {
        font-size: 0.9rem;
    }
}
    </style>
</head>
     <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" id="closeSidebarBtn">&times;</a>
        <a href="index.html">
            <lord-icon src="https://cdn.lordicon.com/jvucoldz.json" trigger="hover" colors="primary:#ffffff,secondary:#08a88a" style="width:50px;height:50px"></lord-icon> Read Quran
        </a>
        <a href="read-quran-by-juzz.html">
            <lord-icon src="https://cdn.lordicon.com/hpivxauj.json" trigger="hover" colors="primary:#ffffff,secondary:#08a88a" style="width:50px;height:50px"></lord-icon> Read in Juzz
        </a>
        <a href="tracks.html">
            <lord-icon src="https://cdn.lordicon.com/wxnxiano.json" trigger="hover" colors="primary:#ffffff,secondary:#08a88a" style="width:50px;height:50px"></lord-icon> Listen to Quran
        </a>
        <a href="prayer-times.html">
            <lord-icon src="https://cdn.lordicon.com/tftaqjwp.json" trigger="hover" colors="primary:#ffffff,secondary:#08a88a" style="width:50px;height:50px"></lord-icon> prayer Time
        </a>
        <a href="donate.html">
            <lord-icon src="https://cdn.lordicon.com/rjzlnunf.json" trigger="hover" colors="primary:#ffffff,secondary:#08a88a" style="width:50px;height:50px"></lord-icon> Donate with love
        </a>
    </div>

    <div id="main">
        <button class="openbtn" id="openSidebarBtn">&#9776; Quran Pro</button>
<body class="min-h-screen pb-8 scrollbar">
    <!-- Navigation -->
    <nav class="custom-gradient shadow-lg text-white sticky top-0 z-50 nav-shine">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3 animate__animated animate__fadeInLeft">
                    <lord-icon
                        src="https://cdn.lordicon.com/xnwbsupk.json"
                        trigger="loop"
                        colors="primary:#ffffff"
                        style="width:40px;height:40px">
                    </lord-icon>
                    <h1 class="text-2xl font-bold">Prayer Times | أوقات الصلاة</h1>
                </div>
                <div class="flex items-center space-x-4 animate__animated animate__fadeInRight">
                    <div id="current-date" class="text-white font-medium hidden md:block"></div>
                    <div id="location-display" class="text-white font-semibold bg-indigo-700 px-3 py-1 rounded-full text-sm flex items-center">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        <span>Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- Next Prayer Counter -->
        <div class="bg-white bg-opacity-90 rounded-2xl shadow-xl p-6 mb-8 transform transition-all duration-500 animate__animated animate__fadeInUp backdrop-filter backdrop-blur-md border border-indigo-100">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center mb-4 md:mb-0">
                    <lord-icon
                        src="https://cdn.lordicon.com/osvvqecf.json"
                        trigger="loop"
                        colors="primary:#6366f1,secondary:#8b5cf6"
                        style="width:64px;height:64px" class="icon-float">
                    </lord-icon>
                    <div class="ml-4">
                        <h2 class="text-2xl font-bold text-indigo-600">Next Prayer | الصلاة القادمة</h2>
                        <p id="next-prayer-name" class="text-lg text-gray-600 flex flex-col md:flex-row">
                            <span class="mr-2">Loading...</span>
                            <span class="arabic mr-2">جاري التحميل...</span>
                        </p>
                    </div>
                </div>
                <div class="text-center">
                    <div id="time-remaining" class="countdown text-4xl font-bold text-indigo-600">--:--:--</div>
                    <p class="text-gray-500 text-sm">Time Remaining | الوقت المتبقي</p>
                </div>
            </div>
        </div>

      <!-- AdSense Ad Container -->
<div class="ad-container animate__animated animate__fadeIn">
    <ins class="adsbygoogle"
         style="display:block; text-align:center;"
         data-ad-layout="in-article"
         data-ad-format="fluid"
         data-ad-client="ca-pub-1850217813586802"
         data-ad-slot="1343025343"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>

        <!-- Prayer Times Grid -->
        <div id="prayer-times" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <!-- Prayer cards will be inserted here by JavaScript -->
        </div>
    </main>
     <!-- AdSense Ad Container -->
<div class="ad-container animate__animated animate__fadeIn" style="text-align:center; margin: 10px 0;">
    <ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-1850217813586802"
     data-ad-slot="1454600783"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

    <!-- Benefits of Prayer Section -->
<section id="benefits" class="benefits-section py-16">
    <div class="container mx-auto px-4">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold mb-3 benefits-title">Benefits of Prayer</h2>
            <div class="w-24 h-1 custom-gradient mx-auto rounded-full"></div>
            <p class="mt-4 text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">Discover how regular prayer can transform your life spiritually, mentally, and physically.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Benefit Card 1 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/tdxypxgp.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Spiritual Connection</h3>
                <p class="benefit-description">Prayer creates a direct connection with Allah, strengthening your faith and bringing you closer to divine guidance.</p>
            </div>

            <!-- Benefit Card 2 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/nkmsrxys.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Mental Peace</h3>
                <p class="benefit-description">Regular prayer reduces anxiety and stress, promoting mental clarity and emotional balance in your daily life.</p>
            </div>

            <!-- Benefit Card 3 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/cjieiyzp.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Physical Well-being</h3>
                <p class="benefit-description">The movements in prayer serve as a form of gentle exercise, improving flexibility, posture, and overall physical health.</p>
            </div>

            <!-- Benefit Card 4 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/zpxybbhl.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Community Building</h3>
                <p class="benefit-description">Congregational prayers foster a sense of unity and brotherhood, strengthening community bonds and social support.</p>
            </div>

            <!-- Benefit Card 5 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/dycatgju.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Inner Discipline</h3>
                <p class="benefit-description">Maintaining regular prayer times helps develop self-discipline and structure that extends to other areas of your life.</p>
            </div>

            <!-- Benefit Card 6 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/rqqkvjqf.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Life Perspective</h3>
                <p class="benefit-description">Prayer reminds us of our purpose and helps maintain perspective, placing worldly concerns in their proper context.</p>
            </div>
        </div>
    </div>
</section>

    <!-- Footer -->
    <footer class="mt-12 pt-8 pb-6 text-center text-gray-500">
        <div class="flex justify-center mb-4">
            <lord-icon
                src="https://cdn.lordicon.com/dnmvmpfk.json"
                trigger="hover"
                colors="primary:#6366f1"
                style="width:48px;height:48px">
            </lord-icon>
        </div>
        <p>Prayer Times Tool &copy; 2025 | Accurate Islamic Prayer Times</p>
    </footer>
    <script>
 document.addEventListener('DOMContentLoaded', function() {
    function openNav() {
        document.getElementById("mySidebar").classList.add("open");
        document.getElementById("sidebarOverlay").classList.add("active");
    }

    function closeNav() {
        document.getElementById("mySidebar").classList.remove("open");
        document.getElementById("sidebarOverlay").classList.remove("active");
    }

    document.getElementById('openSidebarBtn').addEventListener('click', openNav);
    document.getElementById('closeSidebarBtn').addEventListener('click', closeNav);
    document.getElementById('sidebarOverlay').addEventListener('click', closeNav);

    let lastScrollTop = 0;
    const header = document.querySelector('header');
    const sidebar = document.getElementById('mySidebar');
    let scrollTimeout;

    function applyScrollEffects() {
        const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

        if (currentScrollTop > lastScrollTop) {
            header.classList.remove('header-visible');
            header.classList.add('header-hidden');
            sidebar.classList.add('blur-effect');
        } else {
            header.classList.remove('header-hidden');
            header.classList.add('header-visible');
            sidebar.classList.remove('blur-effect');
        }

        lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop;

        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            header.classList.remove('header-hidden');
            header.classList.add('header-visible');
            sidebar.classList.remove('blur-effect');
        }, 200);
    }

    window.addEventListener('scroll', applyScrollEffects);
});

// Prayer names in Arabic
const prayerNamesArabic = {
    Fajr: 'الفجر',
    Sunrise: 'الشروق',
    Dhuhr: 'الظهر',
    Asr: 'العصر',
    Maghrib: 'المغرب',
    Isha: 'العشاء'
};

// Prayer descriptions in Arabic
const prayerDescArabic = {
    Fajr: 'صلاة الفجر',
    Sunrise: 'شروق الشمس',
    Dhuhr: 'صلاة الظهر',
    Asr: 'صلاة العصر',
    Maghrib: 'صلاة المغرب',
    Isha: 'صلاة العشاء'
};

// Lord icon sources for each prayer time
const prayerIcons = {
    Fajr: 'https://cdn.lordicon.com/spgozyor.json',
    Sunrise: 'https://cdn.lordicon.com/qtedxnsm.json',
    Dhuhr: 'https://cdn.lordicon.com/oaflahpk.json',
    Asr: 'https://cdn.lordicon.com/uqpazftn.json',
    Maghrib: 'https://cdn.lordicon.com/wxnxiano.json',
    Isha: 'https://cdn.lordicon.com/udwhdpod.json'
};

// Color schemes for each prayer
const prayerColors = {
    Fajr: ['#6366f1', '#9333ea'],
    Sunrise: ['#f59e0b', '#d97706'],
    Dhuhr: ['#3b82f6', '#1d4ed8'],
    Asr: ['#10b981', '#065f46'],
    Maghrib: ['#ef4444', '#b91c1c'],
    Isha: ['#6366f1', '#4338ca']
};

// Default calculation methods - simplified
const CALCULATION_METHOD = { id: 3, name: 'Muslim World League' };
const ASR_JURISTIC_METHOD = 0; // 0 for Shafi'i

// Global variable to store the countdown timer
let countdownTimer = null;

// Current position
let currentPosition = {
    latitude: null,
    longitude: null
};

// ======================== API INTEGRATION ======================== //

// Fetch prayer times from API
async function fetchPrayerTimes(latitude, longitude, date) {
    try {
        updateLoadingState(true, 'Fetching prayer times...');
        
        // Format date as YYYY-MM-DD
        const formattedDate = date.toISOString().split('T')[0];
        
        // Create API URL with parameters - fixed URL construction
        const url = new URL('https://api.aladhan.com/v1/timings');
        url.search = new URLSearchParams({
            latitude: latitude,
            longitude: longitude,
            method: CALCULATION_METHOD.id,
            adjustment: 0,
            tune: "0,0,0,0,0,0,0,0,0",
            school: ASR_JURISTIC_METHOD,
            date: formattedDate
        });
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        updateLoadingState(false);
        
        if (data.code === 200 && data.data && data.data.timings) {
            return formatPrayerTimesFromAPI(data.data.timings);
        } else {
            throw new Error('Invalid data format received from API');
        }
    } catch (error) {
        updateLoadingState(false);
        console.error('Error fetching prayer times:', error);
        
        // Show error using SweetAlert
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to fetch prayer times. Please try again later.',
            confirmButtonColor: '#6366f1'
        });
        
        // Return empty times
        return {
            Fajr: "-----",
            Sunrise: "-----",
            Dhuhr: "-----",
            Asr: "-----",
            Maghrib: "-----",
            Isha: "-----"
        };
    }
}

// Format times from API to match our format
function formatPrayerTimesFromAPI(timings) {
    // Convert API response to our format and convert to 12-hour format
    return {
        Fajr: convertTo12HourFormat(timings.Fajr),
        Sunrise: convertTo12HourFormat(timings.Sunrise),
        Dhuhr: convertTo12HourFormat(timings.Dhuhr),
        Asr: convertTo12HourFormat(timings.Asr),
        Maghrib: convertTo12HourFormat(timings.Maghrib),
        Isha: convertTo12HourFormat(timings.Isha)
    };
}

// Convert time from 24-hour format to 12-hour format
function convertTo12HourFormat(timeStr) {
    if (!timeStr || timeStr === "-----") return "-----";
    
    const [hours24, minutes] = timeStr.split(':').map(Number);
    
    if (isNaN(hours24) || isNaN(minutes)) return "-----";
    
    const period = hours24 >= 12 ? 'PM' : 'AM';
    const hours12 = hours24 % 12 || 12;
    
    return `${hours12.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')} ${period}`;
}

// ======================== FORMATTING FUNCTIONS ======================== //

// Format time string to Arabic numerals
function formatTimeArabic(timeStr) {
    if (timeStr === "-----") return "-----";
    
    // Convert to 24-hour format first
    const [time, period] = timeStr.split(' ');
    let [hours, minutes] = time.split(':').map(Number);
    
    if (period === 'PM' && hours !== 12) hours += 12;
    if (period === 'AM' && hours === 12) hours = 0;
    
    // Format with Arabic numerals
    const arabicDigits = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
    const hoursStr = hours.toString().padStart(2, '0').split('').map(d => arabicDigits[parseInt(d)]).join('');
    const minutesStr = minutes.toString().padStart(2, '0').split('').map(d => arabicDigits[parseInt(d)]).join('');
    
    return `${hoursStr}:${minutesStr}`;
}

// Convert time string to Date object for comparison
function convertTimeStringToDate(timeStr) {
    if (timeStr === "-----") return null;
    
    const today = new Date();
    const [time, period] = timeStr.split(' ');
    let [hours, minutes] = time.split(':').map(Number);
    
    if (period === 'PM' && hours !== 12) hours += 12;
    if (period === 'AM' && hours === 12) hours = 0;
    
    const result = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hours, minutes);
    return result;
}

// ======================== UI UPDATE FUNCTIONS ======================== //

// Safely get DOM element with fallback
function safeGetElement(id, fallback = null) {
    const element = document.getElementById(id);
    if (!element && fallback) {
        console.warn(`Element with ID '${id}' not found, creating it`);
        const newElement = document.createElement(fallback);
        newElement.id = id;
        
        // Make sure document.body exists before appending
        if (document.body) {
            document.body.appendChild(newElement);
            return newElement;
        } else {
            console.error('Document body not available for appending element');
            return null;
        }
    }
    return element;
}

// Display the prayer times in the UI
function displayPrayerTimes(times) {
    const container = safeGetElement('prayer-times', 'div');
    if (!container) {
        console.error('Prayer times container not found and could not be created');
        return;
    }
    
    container.innerHTML = '';

    const prayers = {
        Fajr: ['Dawn Prayer', 'fa-sun'],
        Sunrise: ['Sunrise', 'fa-sun'],
        Dhuhr: ['Noon Prayer', 'fa-sun'],
        Asr: ['Afternoon Prayer', 'fa-cloud-sun'],
        Maghrib: ['Sunset Prayer', 'fa-moon'],
        Isha: ['Night Prayer', 'fa-star']
    };

    const currentTime = new Date();
    let nextPrayer = null;
    let nextPrayerTime = null;

    // First determine the next prayer
    Object.entries(prayers).forEach(([prayer, [label, icon]]) => {
        if (times[prayer] === "-----") return;
        
        const prayerDate = convertTimeStringToDate(times[prayer]);
        
        if (prayerDate && prayerDate > currentTime && (!nextPrayerTime || prayerDate < nextPrayerTime)) {
            nextPrayer = prayer;
            nextPrayerTime = prayerDate;
        }
    });

    // Handle case where all prayers have passed for the day
    if (!nextPrayer) {
        // Let the user know that we'll show tomorrow's times for Fajr
        const nextPrayerNameElement = safeGetElement('next-prayer-name', 'div');
        if (nextPrayerNameElement) {
            nextPrayerNameElement.innerHTML = `
                <span class="mr-2">All prayers passed for today. Showing countdown to tomorrow's Fajr</span>
                <span class="arabic mr-2">انتهت جميع الصلوات لهذا اليوم. عرض العد التنازلي لصلاة الفجر غدًا</span>
            `;
        }
        
        // Fetch tomorrow's times for Fajr
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        fetchPrayerTimes(
            currentPosition.latitude, 
            currentPosition.longitude, 
            tomorrow
        ).then(tomorrowTimes => {
            if (tomorrowTimes.Fajr !== "-----") {
                nextPrayer = 'Fajr';
                
                // Create a date for tomorrow's Fajr
                const fajrTime = convertTimeStringToDate(tomorrowTimes.Fajr);
                if (fajrTime) {
                    // Set the date specifically to tomorrow
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    fajrTime.setFullYear(tomorrow.getFullYear());
                    fajrTime.setMonth(tomorrow.getMonth());
                    fajrTime.setDate(tomorrow.getDate());
                    
                    nextPrayerTime = fajrTime;
                    updateCountdown(nextPrayerTime);
                }
            }
        }).catch(error => {
            console.error("Error fetching tomorrow's prayer times:", error);
            const timeRemainingElement = safeGetElement('time-remaining', 'div');
            if (timeRemainingElement) {
                timeRemainingElement.textContent = "--:--:--";
            }
        });
    }

    // Now create cards
    Object.entries(prayers).forEach(([prayer, [label, icon]], index) => {
        const isActive = prayer === nextPrayer;
        const [primary, secondary] = prayerColors[prayer] || ['#6366f1', '#8b5cf6'];
        
        const card = document.createElement('div');
        card.className = `prayer-time-card rounded-xl shadow-lg p-6 animate__animated animate__fadeIn animate__delay-${index % 5}s ${isActive ? 'active' : ''}`;
        if (isActive) {
            card.style.background = `linear-gradient(145deg, ${primary}15, ${secondary}15)`;
        }
        
        card.innerHTML = `
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h3 class="text-xl font-bold ${isActive ? 'text-indigo-700' : 'text-indigo-600'}">${label}</h3>
                    <p class="text-gray-600">${prayer} | ${prayerNamesArabic[prayer]}</p>
                </div>
                <lord-icon
                    src="${prayerIcons[prayer]}"
                    trigger="hover"
                    colors="primary:${primary},secondary:${secondary}"
                    style="width:48px;height:48px">
                </lord-icon>
            </div>
            <div class="flex items-center justify-between mt-4">
                <div class="flex flex-col">
                    <span class="text-sm text-gray-500">English</span>
                    <span class="text-lg font-semibold ${isActive ? 'text-indigo-700' : 'text-gray-700'}">${times[prayer]}</span>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-sm text-gray-500">عربي</span>
                    <span dir="rtl" class="text-lg font-semibold arabic ${isActive ? 'text-indigo-700' : 'text-gray-700'}">${formatTimeArabic(times[prayer])}</span>
                </div>
            </div>
            ${isActive ? '<div class="mt-2 text-xs text-indigo-600 font-medium">Next Prayer</div>' : ''}
        `;
        container.appendChild(card);
    });

    // Update next prayer information
    if (nextPrayer && nextPrayerTime) {
        const nextPrayerNameElement = safeGetElement('next-prayer-name', 'div');
        if (nextPrayerNameElement) {
            nextPrayerNameElement.innerHTML = `
                <span class="mr-2">${prayers[nextPrayer][0]} (${nextPrayer})</span>
                <span class="arabic mr-2">${prayerDescArabic[nextPrayer]} (${prayerNamesArabic[nextPrayer]})</span>
            `;
        }
        updateCountdown(nextPrayerTime);
    }
}

// Update the countdown timer
function updateCountdown(targetTime) {
    if (!targetTime) return;
    
    const timeRemainingElement = safeGetElement('time-remaining', 'div');
    if (!timeRemainingElement) {
        console.error('Time remaining element not found and could not be created');
        return;
    }
    
    // Clear any existing timer before starting a new one
    if (countdownTimer) {
        clearTimeout(countdownTimer);
        countdownTimer = null;
    }
    
    const updateTimer = () => {
        const now = new Date();
        const diff = targetTime - now;
        
        if (diff <= 0) {
            timeRemainingElement.textContent = "00:00:00";
            // Refresh the page calculations when time is up
            setTimeout(() => {
                // Show notification that prayer time has arrived
                const prayerName = document.getElementById('next-prayer-name')?.innerText.split('(')[0].trim() || 'Prayer';
                
                Swal.fire({
                    icon: 'info',
                    title: `${prayerName} Time`,
                    text: `It's time for ${prayerName}`,
                    confirmButtonColor: '#6366f1',
                    timer: 5000,
                    timerProgressBar: true
                });
                
                refreshPrayerTimes();
            }, 1000);
            return;
        }
        
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        timeRemainingElement.textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Update every second
        countdownTimer = setTimeout(updateTimer, 1000);
    };
    
    updateTimer();
}

// ======================== LOCATION HANDLING ======================== //

// Function to handle location retrieval and updates
async function getCurrentLocation() {
    return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
            return reject(new Error('Geolocation is not supported by your browser'));
        }
        
        // Show loading state
        updateLoadingState(true, 'Retrieving your location...');
        
        navigator.geolocation.getCurrentPosition(
            // Success callback
            (position) => {
                const { latitude, longitude } = position.coords;
                currentPosition = { latitude, longitude };
                updateLoadingState(false);
                resolve(position.coords);
            },
            // Error callback
            (error) => {
                updateLoadingState(false);
                
                let errorMessage;
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        errorMessage = 'Location access was denied. Please provide location access for accurate prayer times.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        errorMessage = 'Location information is unavailable. Using default location.';
                        break;
                    case error.TIMEOUT:
                        errorMessage = 'Location request timed out. Using cached or default location.';
                        break;
                    default:
                        errorMessage = 'An unknown error occurred while retrieving location.';
                }
                
                reject(new Error(errorMessage));
            },
            // Options
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 300000 // 5 minutes
            }
        );
    });
}

// Show/hide a loading indicator
function updateLoadingState(isLoading, message = 'Loading...') {
    const locationDisplay = safeGetElement('location-display', 'div');
    if (!locationDisplay) return;
    
    if (isLoading) {
        locationDisplay.innerHTML = `
            <div class="flex items-center">
                <div class="animate-spin mr-2">
                    <i class="fas fa-circle-notch"></i>
                </div>
                <span>${message}</span>
            </div>
        `;
    } else if (currentPosition.latitude && currentPosition.longitude) {
        // Only update if we have a valid position
        getLocationName(currentPosition.latitude, currentPosition.longitude)
            .then(locationName => {
                updateLocationDisplay(locationName);
            })
            .catch(() => {
                // Show coordinates if location name fetching fails
                updateLocationDisplay(`Location: ${currentPosition.latitude.toFixed(4)}, ${currentPosition.longitude.toFixed(4)}`);
            });
    } else {
        // Show default message when there's no position yet
        locationDisplay.innerHTML = `
            <i class="fas fa-map-marker-alt mr-1"></i>
            <span>No location data</span>
            <button id="get-location-btn" class="ml-2 px-2 py-1 bg-indigo-600 text-white rounded text-xs">
                Get Location
            </button>
        `;
        
        // Add event listener to the button
        const getLocationBtn = document.getElementById('get-location-btn');
        if (getLocationBtn) {
            getLocationBtn.addEventListener('click', () => {
                requestLocationPermission();
            });
        }
    }
}

// Request location permission explicitly
function requestLocationPermission() {
    Swal.fire({
        title: 'Location Access',
        text: 'This app needs your location to provide accurate prayer times. Allow access to your location?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#6366f1',
        cancelButtonColor: '#ef4444',
        confirmButtonText: 'Yes, allow',
        cancelButtonText: 'No, use default'
    }).then((result) => {
        if (result.isConfirmed) {
            initialize();
        } else {
            // Use default location
            useDefaultLocation();
        }
    });
}

// Use default location (Mecca)
function useDefaultLocation() {
    // Set Mecca as default location
    currentPosition = { 
        latitude: 21.4225, 
        longitude: 39.8262 
    };
    
    Swal.fire({
        icon: 'info',
        title: 'Default Location',
        text: 'Using Mecca as the default location for prayer times.',
        confirmButtonColor: '#6366f1',
        timer: 3000,
        timerProgressBar: true
    });
    
    updateLocationDisplay('Mecca (Default)');
    refreshPrayerTimes();
}

// Fetch location name from coordinates
async function getLocationName(latitude, longitude) {
    try {
        const response = await fetch(
            `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=10`,
            { 
                headers: { 
                    'Accept-Language': 'en',
                    'User-Agent': 'PrayerTimesApp/1.0'
                } 
            }
        );
        
        if (!response.ok) {
            throw new Error('Failed to fetch location data');
        }
        
        const data = await response.json();
        
        return data.address.city || 
               data.address.town || 
               data.address.village || 
               data.address.county ||
               data.address.state ||
               "Unknown Location";
    } catch (error) {
        console.error('Error fetching location name:', error);
        return "Unknown Location";
    }
}

// Update the location display
function updateLocationDisplay(locationName) {
    const locationDisplay = safeGetElement('location-display', 'div');
    if (!locationDisplay) return;
    
    locationDisplay.innerHTML = `
        <i class="fas fa-map-marker-alt mr-1"></i>
        <span>${locationName}</span>
        <button id="refresh-location-btn" class="ml-2 px-2 py-1 bg-indigo-600 text-white rounded text-xs">
            <i class="fas fa-sync-alt"></i>
        </button>
    `;
    
    // Add event listener to the refresh button
    const refreshLocationBtn = document.getElementById('refresh-location-btn');
    if (refreshLocationBtn) {
        refreshLocationBtn.addEventListener('click', () => {
            Swal.fire({
                title: 'Refresh Location',
                text: 'Do you want to update your current location?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#6366f1',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Yes, update'
            }).then((result) => {
                if (result.isConfirmed) {
                    initialize();
                }
            });
        });
    }
}

// Handle location error
function handleLocationError(error) {
    console.error('Location error:', error);
    
    Swal.fire({
        title: 'Location Error',
        text: `${error.message || 'Unable to determine your location.'} Would you like to use the default location (Mecca)?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#6366f1',
        cancelButtonColor: '#ef4444',
        confirmButtonText: 'Yes, use Mecca',
        cancelButtonText: 'No'
    }).then((result) => {
        if (result.isConfirmed) {
            useDefaultLocation();
        } else {
            // Show location button in the display area
            updateLoadingState(false);
        }
    });
}

// ======================== APPLICATION INITIALIZATION ======================== //

// Refresh prayer times with current settings
async function refreshPrayerTimes() {
    if (!currentPosition.latitude || !currentPosition.longitude) {
        console.error('No location available');
        
        Swal.fire({
            icon: 'warning',
            title: 'No Location',
            text: 'Location data is not available. Please provide your location for accurate prayer times.',
            confirmButtonColor: '#6366f1',
            showCancelButton: true,
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Provide Location',
            cancelButtonText: 'Use Default'
        }).then((result) => {
            if (result.isConfirmed) {
                requestLocationPermission();
            } else {
                useDefaultLocation();
            }
        });
        
        return;
    }
    
    try {
        const today = new Date();
        const times = await fetchPrayerTimes(
            currentPosition.latitude, 
            currentPosition.longitude, 
            today
        );
        
        displayPrayerTimes(times);
    } catch (error) {
        console.error('Error refreshing prayer times:', error);
        
        Swal.fire({
            icon: 'error',
            title: 'Refresh Error',
            text: 'Failed to refresh prayer times. Please try again.',
            confirmButtonColor: '#6366f1'
        });
    }
}

// Initialize the application
async function initialize() {
    try {
        // Show welcome message on first load
        if (!localStorage.getItem('appInitialized')) {
            Swal.fire({
                title: 'Welcome to Prayer Times App',
                text: 'This app helps you track Islamic prayer times based on your location.',
                icon: 'info',
                confirmButtonColor: '#6366f1',
                timer: 3000,
                timerProgressBar: true
            });
            
            localStorage.setItem('appInitialized', 'true');
        }
        
        // Get user location
        const coords = await getCurrentLocation();
        
        // Get location name
        const locationName = await getLocationName(coords.latitude, coords.longitude);
        updateLocationDisplay(locationName);
        
        // Calculate and display prayer times
        await refreshPrayerTimes();
        
        // Show success message
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
        
        Toast.fire({
            icon: 'success',
            title: 'Prayer times updated successfully'
        });
        
    } catch (error) {
        handleLocationError(error);
    }
}

// ======================== LANGUAGE FUNCTIONS ======================== //

// Toggle Arabic/English display priority
function toggleLanguage() {
    const container = document.getElementById('app-container');
    if (container) {
        container.classList.toggle('arabic-primary');
        
        // Save preference
        const isArabicPrimary = container.classList.contains('arabic-primary');
        localStorage.setItem('arabicPrimary', isArabicPrimary ? 'true' : 'false');
        
        // Update button text
        const langButton = safeGetElement('language-toggle', 'button');
        if (langButton) {
            langButton.textContent = isArabicPrimary ? 'English' : 'العربية';
        }
        
        // Show notification
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 2000,
            timerProgressBar: true
        });
        
        Toast.fire({
            icon: 'success',
            title: isArabicPrimary ? 'تم التغيير إلى العربية' : 'Switched to English'
        });
    }
}

// Load language preferences
function loadPreferences() {
    // Language preference
    const arabicPrimarySetting = localStorage.getItem('arabicPrimary');
    if (arabicPrimarySetting === 'true') {
        const container = document.getElementById('app-container');
        if (container) {
            container.classList.add('arabic-primary');
        }
        
        const langButton = safeGetElement('language-toggle', 'button');
        if (langButton) {
            langButton.textContent = 'English';
        }
    }
}

// ======================== RESPONSIVE LAYOUT ADJUSTMENTS ======================== //

// Adjust layout based on screen size
function handleResponsiveLayout() {
    const prayerContainer = document.getElementById('prayer-times');
    if (!prayerContainer) return;
    
    // Adjust grid columns based on screen width
    if (window.innerWidth < 640) {
        prayerContainer.className = 'grid grid-cols-1 gap-4 mt-6';
    } else if (window.innerWidth < 1024) {
        prayerContainer.className = 'grid grid-cols-2 gap-4 mt-6';
    } else {
        prayerContainer.className = 'grid grid-cols-3 gap-4 mt-6';
    }
}

// ======================== PRAYER NOTIFICATIONS ======================== //

// Function to schedule notifications for upcoming prayers
function schedulePrayerNotifications(times) {
    if (!("Notification" in window)) {
        console.warn("This browser does not support notifications");
        return;
    }
    
    // Check if we have permission
    if (Notification.permission === "granted") {
        setupNotifications(times);
    } else if (Notification.permission !== "denied") {
        Swal.fire({
            title: 'Enable Notifications?',
            text: 'Would you like to receive notifications for prayer times?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#6366f1',
            cancelButtonColor: '#64748b',
            confirmButtonText: 'Yes, enable',
            cancelButtonText: 'No, thanks'
        }).then((result) => {
            if (result.isConfirmed) {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        setupNotifications(times);
                    }
                });
            }
        });
    }
}

// Set up notifications for each prayer time
function setupNotifications(times) {
    const now = new Date();
    
    Object.entries(times).forEach(([prayer, timeStr]) => {
        if (timeStr === "-----") return;
        
        const prayerDate = convertTimeStringToDate(timeStr);
        if (!prayerDate || prayerDate <= now) return;
        
        // Schedule notification 5 minutes before prayer time
        const notificationTime = new Date(prayerDate);
        notificationTime.setMinutes(notificationTime.getMinutes() - 5);
        
        const timeUntilNotification = notificationTime - now;
        if (timeUntilNotification <= 0) return;
        
        setTimeout(() => {
            const notification = new Notification(${prayer} Prayer Time Soon, {
                body: ${prayer} prayer time is in 5 minutes,
                    icon: '/favicon.ico'
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(`${prayer} Prayer Time Soon`, {
                            body: `${prayer} prayer time is in 5 minutes`,
                            icon: '/favicon.ico',
                silent: false
            });
            
            notification.onclick = function() {
                window.focus();
                this.close();
            };
        }, timeUntilNotification);
    });
}

// ======================== EVENT LISTENERS ======================== //

// Add event listeners when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the app
    initialize();
    
    // Set up language toggle
    const langButton = safeGetElement('language-toggle', 'button');
    if (langButton) {
        langButton.addEventListener('click', toggleLanguage);
        // Set initial text
        langButton.textContent = document.getElementById('app-container')?.classList.contains('arabic-primary') ? 'English' : 'العربية';
    }
    
    // Set up refresh button
    const refreshButton = safeGetElement('refresh-button', 'button');
    if (refreshButton) {
        refreshButton.addEventListener('click', refreshPrayerTimes);
    }
    
    // Set up date display
    const dateDisplay = safeGetElement('date-display', 'div');
    if (dateDisplay) {
        const today = new Date();
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        dateDisplay.innerHTML = `
            <div class="flex flex-col items-center">
                <span>${today.toLocaleDateString('en-US', options)}</span>
                <span class="arabic">${today.toLocaleDateString('ar-SA', options)}</span>
            </div>
        `;
    }
    
    // Handle responsive layout
    handleResponsiveLayout();
    window.addEventListener('resize', handleResponsiveLayout);
    
    // Load saved preferences
    loadPreferences();
    
    // Set up notification settings button
    const notificationButton = safeGetElement('notification-settings', 'button');
    if (notificationButton) {
        notificationButton.addEventListener('click', () => {
            Swal.fire({
                title: 'Notification Settings',
                html: `
                    <div class="text-left">
                        <p class="mb-3">Would you like to receive notifications for prayer times?</p>
                        <label class="flex items-center mb-2">
                            <input type="checkbox" id="notify-before" class="mr-2">
                            Notify 5 minutes before prayer time
                        </label>
                        <label class="flex items-center mb-2">
                            <input type="checkbox" id="notify-at" class="mr-2">
                            Notify at prayer time
                        </label>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#6366f1',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Save Settings',
                cancelButtonText: 'Cancel',
                preConfirm: () => {
                    const notifyBefore = document.getElementById('notify-before').checked;
                    const notifyAt = document.getElementById('notify-at').checked;
                    
                    localStorage.setItem('notifyBefore', notifyBefore);
                    localStorage.setItem('notifyAt', notifyAt);
                    
                    return { notifyBefore, notifyAt };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            const Toast = Swal.mixin({
                                toast: true,
                                position: 'top-end',
                                showConfirmButton: false,
                                timer: 2000,
                                timerProgressBar: true
                            });
                            
                            Toast.fire({
                                icon: 'success',
                                title: 'Notification settings saved'
                            });
                            
                            // Refresh notifications with current prayer times
                            refreshPrayerTimes();
                        }
                    });
                }
            });
        });
    }
});

// ======================== SETTINGS & CUSTOMIZATION ======================== //

// Function to open settings modal
function openSettings() {
    Swal.fire({
        title: 'Prayer Times Settings',
        html: `
            <div class="text-left">
                <h3 class="font-bold mb-3">Calculation Method</h3>
                <select id="calculation-method" class="w-full p-2 border rounded mb-4">
                    <option value="0">Shia Ithna-Ashari</option>
                    <option value="1">University of Islamic Sciences, Karachi</option>
                    <option value="2">Islamic Society of North America</option>
                    <option value="3" selected>Muslim World League</option>
                    <option value="4">Umm Al-Qura University, Mecca</option>
                    <option value="5">Egyptian General Authority of Survey</option>
                    <option value="7">Institute of Geophysics, University of Tehran</option>
                    <option value="12">Union des Organisations Islamiques de France</option>
                    <option value="13">Spiritual Administration of Muslims of Russia</option>
                </select>
                
                <h3 class="font-bold mb-3">Juristic Method (Asr)</h3>
                <select id="juristic-method" class="w-full p-2 border rounded mb-4">
                    <option value="0" selected>Standard (Shafi'i, Maliki, Hanbali)</option>
                    <option value="1">Hanafi</option>
                </select>
                
                <h3 class="font-bold mb-3">Display Options</h3>
                <label class="flex items-center mb-2">
                    <input type="checkbox" id="show-arabic" class="mr-2" checked>
                    Show Arabic times
                </label>
                
                <label class="flex items-center mb-2">
                    <input type="checkbox" id="dark-mode" class="mr-2">
                    Dark Mode
                </label>
            </div>
        `,
        showCancelButton: true,
        confirmButtonColor: '#6366f1',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Save Settings',
        cancelButtonText: 'Cancel',
        willOpen: () => {
            // Set values from current settings
            document.getElementById('calculation-method').value = CALCULATION_METHOD.id;
            document.getElementById('juristic-method').value = ASR_JURISTIC_METHOD;
            document.getElementById('show-arabic').checked = localStorage.getItem('showArabic') !== 'false';
            document.getElementById('dark-mode').checked = document.body.classList.contains('dark-mode');
        },
        preConfirm: () => {
            const calculationMethodId = parseInt(document.getElementById('calculation-method').value);
            const calculationMethodName = document.getElementById('calculation-method').options[document.getElementById('calculation-method').selectedIndex].text;
            const juristicMethod = parseInt(document.getElementById('juristic-method').value);
            const showArabic = document.getElementById('show-arabic').checked;
            const darkMode = document.getElementById('dark-mode').checked;
            
            return { 
                calculationMethodId, 
                calculationMethodName, 
                juristicMethod, 
                showArabic, 
                darkMode 
            };
        }
    }).then((result) => {
        if (result.isConfirmed) {
            // Update global settings
            CALCULATION_METHOD.id = result.value.calculationMethodId;
            CALCULATION_METHOD.name = result.value.calculationMethodName;
            ASR_JURISTIC_METHOD = result.value.juristicMethod;
            
            // Save to localStorage
            localStorage.setItem('calculationMethod', JSON.stringify(CALCULATION_METHOD));
            localStorage.setItem('asrJuristicMethod', ASR_JURISTIC_METHOD);
            localStorage.setItem('showArabic', result.value.showArabic);
            
            // Toggle dark mode
            if (result.value.darkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            localStorage.setItem('darkMode', result.value.darkMode);
            
            // Refresh prayer times with new settings
            refreshPrayerTimes();
            
            // Show success message
            const Toast = Swal.mixin({
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 2000,
                timerProgressBar: true
            });
            
            Toast.fire({
                icon: 'success',
                title: 'Settings saved successfully'
            });
        }
    });
}

// ======================== OFFLINE CAPABILITIES ======================== //

// Check if application is online
function isOnline() {
    return navigator.onLine;
}

// Load cached prayer times when offline
function loadCachedPrayerTimes() {
    try {
        const cachedData = localStorage.getItem('cachedPrayerTimes');
        if (cachedData) {
            const { times, timestamp } = JSON.parse(cachedData);
            
            // Check if cache is from today
            const cacheDate = new Date(timestamp);
            const today = new Date();
            
            const isSameDay = cacheDate.getDate() === today.getDate() && 
                              cacheDate.getMonth() === today.getMonth() &&
                              cacheDate.getFullYear() === today.getFullYear();
            
            if (isSameDay) {
                displayPrayerTimes(times);
                
                // Show offline indicator
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top',
                    showConfirmButton: false,
                    timer: 3000,
                    timerProgressBar: true
                });
                
                Toast.fire({
                    icon: 'warning',
                    title: 'You are offline. Showing cached prayer times.'
                });
                
                return true;
            }
        }
        
        return false;
    } catch (error) {
        console.error('Error loading cached prayer times:', error);
        return false;
    }
}

// Cache prayer times for offline use
function cachePrayerTimes(times) {
    try {
        localStorage.setItem('cachedPrayerTimes', JSON.stringify({
            times,
            timestamp: new Date().toISOString()
        }));
    } catch (error) {
        console.error('Error caching prayer times:', error);
    }
}

// Handle online/offline events
window.addEventListener('online', () => {
    const Toast = Swal.mixin({
        toast: true,
        position: 'top',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true
    });
    
    Toast.fire({
        icon: 'success',
        title: 'You are back online. Refreshing prayer times.'
    });
    
    refreshPrayerTimes();
});

window.addEventListener('offline', () => {
    const Toast = Swal.mixin({
        toast: true,
        position: 'top',
        showConfirmButton: false,
        timer: 3000,
        timerProgressBar: true
    });
    
    Toast.fire({
        icon: 'warning',
        title: 'You are offline. Using cached prayer times if available.'
    });
    
    loadCachedPrayerTimes();
});

// Periodically check for new day to refresh prayer times
setInterval(() => {
    const now = new Date();
    
    // If it's just past midnight, refresh prayer times for the new day
    if (now.getHours() === 0 && now.getMinutes() === 0) {
        refreshPrayerTimes();
        
        // Show notification for new day
        if (Notification.permission === "granted") {
            new Notification("New Prayer Day", {
                body: "Prayer times have been updated for the new day",
                icon: '/favicon.ico'
            });
        }
    }
}, 60000); // Check every minute

// Set up settings button
document.addEventListener('DOMContentLoaded', function() {
    const settingsButton = safeGetElement('settings-button', 'button');
    if (settingsButton) {
        settingsButton.addEventListener('click', openSettings);
    }
    
    // Load saved settings from localStorage
    try {
        // Calculation method
        const savedMethod = localStorage.getItem('calculationMethod');
        if (savedMethod) {
            CALCULATION_METHOD = JSON.parse(savedMethod);
        }
        
        // Asr juristic method
        const savedJuristicMethod = localStorage.getItem('asrJuristicMethod');
        if (savedJuristicMethod !== null) {
            ASR_JURISTIC_METHOD = parseInt(savedJuristicMethod);
        }
        
        // Dark mode
        if (localStorage.getItem('darkMode') === 'true') {
            document.body.classList.add('dark-mode');
        }
    } catch (error) {
        console.error('Error loading saved settings:', error);
    }
});

// Service Worker Registration for PWA Support
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
            .then(registration => {
                console.log('ServiceWorker registration successful');
            })
            .catch(error => {
                console.error('ServiceWorker registration failed:', error);
            });
    });
}
    </script>
</body>
</html>
