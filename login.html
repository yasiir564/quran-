<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, OAuthProvider, signInWithPopup, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCCHwRT-Nj3GfPZD-If2P7iMajPjAB9RJA",
      authDomain: "quran-pro-c1df1.firebaseapp.com",
      projectId: "quran-pro-c1df1",
      storageBucket: "quran-pro-c1df1.appspot.com",
      messagingSenderId: "782064856596",
      appId: "1:782064856596:web:3c11c7a0186a2923bac101",
      measurementId: "G-RFVGMM8VYQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Check if the current URL contains a sign-in link for email verification
    if (isSignInWithEmailLink(auth, window.location.href)) {
      const email = localStorage.getItem('emailForSignIn');
      if (email) {
        signInWithEmailLink(auth, email, window.location.href)
          .then((result) => {
            localStorage.removeItem('emailForSignIn');
            handleUserProfile(result.user);
          })
          .catch((error) => {
            alert('Error verifying email: ' + error.message);
          });
      } else {
        alert('No email found in local storage for sign-in.');
      }
    }

    // Add event listener to the Google sign-in button
    document.getElementById('google-login-button').addEventListener('click', () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider)
        .then((result) => {
          handleUserProfile(result.user);
        })
        .catch((error) => {
          alert('Error signing in with Google: ' + error.message);
        });
    });

    // Add event listener to the Apple sign-in button
    document.getElementById('apple-login-button').addEventListener('click', () => {
      const provider = new OAuthProvider('apple.com');
      signInWithPopup(auth, provider)
        .then((result) => {
          handleUserProfile(result.user);
        })
        .catch((error) => {
          alert('Error signing in with Apple: ' + error.message);
        });
    });

    // Add event listener to the email sign-in form
    document.getElementById('email-login-form').addEventListener('submit', (event) => {
      event.preventDefault();
      const email = document.getElementById('email').value;
      sendSignInLinkToEmail(auth, email, {
        url: window.location.href,
        handleCodeInApp: true
      })
      .then(() => {
        // Store the email in local storage
        localStorage.setItem('emailForSignIn', email);
        alert('Please check your email for the activation link.');
      })
      .catch((error) => {
        alert('Error sending activation link: ' + error.message);
      });
    });

    function handleUserProfile(user) {
      const userDocRef = doc(db, "users", user.uid);
      getDoc(userDocRef)
        .then((userDoc) => {
          if (userDoc.exists()) {
            // Store the user's name, email, and profile picture in local storage
            localStorage.setItem("userName", userDoc.data().name);
            localStorage.setItem("userEmail", userDoc.data().email);
            localStorage.setItem("userAvatar", userDoc.data().avatar || user.photoURL || null);
          } else {
            // Create a new user document in Firestore with profile picture
            const avatar = user.photoURL || null;
            setDoc(userDocRef, {
              name: user.displayName,
              email: user.email,
              avatar: avatar
            })
            .then(() => {
              // Store the user's name, email, and profile picture in local storage
              localStorage.setItem("userName", user.displayName);
              localStorage.setItem("userEmail", user.email);
              localStorage.setItem("userAvatar", avatar);
            })
            .catch((error) => {
              alert('Error saving user profile: ' + error.message);
            });
          }
          // Redirect to profile page after storing details
          window.location.href = 'profile.html';
        })
        .catch((error) => {
          if (error.code === 'unavailable') {
            // User is offline, use fallback data
            const name = user.displayName;
            const email = user.email;
            const avatar = user.photoURL || null;
            localStorage.setItem("userName", name);
            localStorage.setItem("userEmail", email);
            localStorage.setItem("userAvatar", avatar);
            window.location.href = 'profile.html';
          } else {
            alert('Error getting user profile: ' + error.message);
          }
        });
    }
  </script>
</head>
<body>
  <h1>Login</h1>
  <button id="google-login-button">Sign in with Google</button>
  <button id="apple-login-button">Sign in with Apple</button>
  <hr>
  <h2>Or sign in with email</h2>
  <form id="email-login-form">
    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required>
    <br>
    <button type="submit">Send Activation Link</button>
  </form>
</body>
</html>

