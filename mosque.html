<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Mosque Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background-color: #f4f7f6;
        }

        body {
            background-color: var(--background-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .mosque-finder-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        #mainMap {
            height: 500px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .search-section {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .advanced-filters {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .mosque-list-container {
            max-height: 70vh;
            overflow-y: auto;
        }

        .mosque-card {
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .mosque-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .details-panel {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .ai-insights {
            background-color: #e6f2ff;
            border-left: 4px solid var(--secondary-color);
            padding: 15px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="mosque-finder-container">
        <div class="row">
            <div class="col-12 text-center mb-4">
                <h1 class="display-4">üïå Advanced Mosque Finder</h1>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-4">
                <div class="search-section">
                    <h3>Search & Filters</h3>
                    <div class="input-group mb-3">
                        <input type="text" id="cityInput" class="form-control" placeholder="Enter city or location">
                        <button id="searchButton" class="btn btn-primary">Search</button>
                    </div>

                    <div class="advanced-filters">
                        <h5>Advanced Filters</h5>
                        <div class="row">
                            <div class="col-md-6 mb-2">
                                <select id="denominationFilter" class="form-select">
                                    <option value="">All Denominations</option>
                                    <option value="sunni">Sunni</option>
                                    <option value="shia">Shia</option>
                                    <option value="sufi">Sufi</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-2">
                                <select id="facilityFilter" class="form-select">
                                    <option value="">Facilities</option>
                                    <option value="women">Women's Section</option>
                                    <option value="education">Islamic Education</option>
                                    <option value="parking">Parking</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="checkbox" id="fridayPrayerCheck">
                            <label class="form-check-label" for="fridayPrayerCheck">
                                Friday Prayer Available
                            </label>
                        </div>
                    </div>

                    <button id="locateButton" class="btn btn-success mt-3 w-100">
                        üåç Use My Location
                    </button>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="row">
                    <div class="col-12 mb-3">
                        <div id="mainMap"></div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mosque-list-container">
                        <div id="mosqueList" class="row g-3"></div>
                    </div>
                    <div class="col-md-6">
                        <div id="mosqueDetails" class="details-panel">
                            <p class="text-muted text-center">Select a mosque to view details</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <script>
        // App Configuration
        const CONFIG = {
            OPENAI_API_KEY: 'sk-proj-...',  // Replace with actual key
            OSM_NOMINATIM_URL: 'https://nominatim.openstreetmap.org/search',
            OVERPASS_API_URL: 'https://overpass-api.de/api/interpreter'
        };

        class MosqueFinder {
            constructor() {
                this.map = null;
                this.currentMarkers = [];
                this.currentMosques = [];
                this.initializeMap();
                this.setupEventListeners();
            }

            initializeMap() {
                this.map = L.map('mainMap').setView([0, 0], 2);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.map);
            }

            setupEventListeners() {
                document.getElementById('searchButton').addEventListener('click', () => this.searchMosques());
                document.getElementById('locateButton').addEventListener('click', () => this.autoLocate());
                document.getElementById('cityInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.searchMosques();
                });
            }

            async searchMosques() {
                const city = document.getElementById('cityInput').value.trim();
                if (!city) {
                    alert('Please enter a city or location');
                    return;
                }

                try {
                    const nominatimResponse = await axios.get(CONFIG.OSM_NOMINATIM_URL, {
                        params: {
                            q: city,
                            format: 'json',
                            limit: 1
                        }
                    });

                    if (nominatimResponse.data.length === 0) {
                        alert('Location not found');
                        return;
                    }

                    const { lat, lon } = nominatimResponse.data[0];
                    this.map.setView([lat, lon], 12);

                    const overpassQuery = `
                        [out:json][timeout:25];
                        (
                            node["amenity"="place_of_worship"]["religion"="muslim"](around:5000,${lat},${lon});
                            way["amenity"="place_of_worship"]["religion"="muslim"](around:5000,${lat},${lon});
                            relation["amenity"="place_of_worship"]["religion"="muslim"](around:5000,${lat},${lon});
                        );
                        out body;
                        >;
                        out skel qt;
                    `;

                    const overpassResponse = await axios.post(CONFIG.OVERPASS_API_URL, overpassQuery);
                    this.processMosques(overpassResponse.data);
                } catch (error) {
                    console.error('Search error:', error);
                    alert('Error searching for mosques');
                }
            }

            processMosques(data) {
                // Clear existing markers
                this.currentMarkers.forEach(marker => this.map.removeLayer(marker));
                this.currentMarkers = [];
                this.currentMosques = [];

                const uniqueMosques = new Set();

                data.elements.forEach(mosque => {
                    if (mosque.type === 'node' && !uniqueMosques.has(mosque.id)) {
                        uniqueMosques.add(mosque.id);

                        const marker = L.marker([mosque.lat, mosque.lon])
                            .addTo(this.map)
                            .bindPopup(mosque.tags.name || 'Unnamed Mosque');

                        this.currentMarkers.push(marker);
                        this.currentMosques.push({
                            id: mosque.id,
                            name: mosque.tags.name || 'Unnamed Mosque',
                            lat: mosque.lat,
                            lon: mosque.lon,
                            tags: mosque.tags
                        });
                    }
                });

                this.renderMosqueList();
            }

            renderMosqueList() {
                const mosqueList = document.getElementById('mosqueList');
                mosqueList.innerHTML = this.currentMosques.map((mosque, index) => `
                    <div class="col-12">
                        <div class="card mosque-card" onclick="mosqueFinder.showMosqueDetails(${index})">
                            <div class="card-body">
                                <h5 class="card-title">${mosque.name}</h5>
                                <p class="card-text text-muted">
                                    ${mosque.tags.denomination || 'Unknown Denomination'}
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            async showMosqueDetails(index) {
                const mosque = this.currentMosques[index];
                const detailsPanel = document.getElementById('mosqueDetails');

                try {
                    // Simulated AI insights (replace with actual AI service)
                    const aiInsights = await this.generateAIInsights(mosque);

                    detailsPanel.innerHTML = `
                        <h3>${mosque.name}</h3>
                        <div class="mb-3">
                            <strong>Location:</strong> 
                            ${mosque.lat.toFixed(4)}, ${mosque.lon.toFixed(4)}
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-header bg-primary text-white">
                                Mosque Details
                            </div>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item">
                                    <strong>Denomination:</strong> 
                                    ${mosque.tags.denomination || 'Not Specified'}
                                </li>
                                <li class="list-group-item">
                                    <strong>Website:</strong> 
                                    ${mosque.tags.website || 'Not Available'}
                                </li>
                            </ul>
                        </div>

                        <div class="ai-insights mt-3">
                            <h4>‚ú® Cultural Insights</h4>
                            <p>${aiInsights}</p>
                        </div>
                    `;
                } catch (error) {
                    console.error('Details error:', error);
                }
            }

            async generateAIInsights(mosque) {
                // Placeholder for AI generation - would typically use OpenAI/Gemini
                return `A culturally rich mosque with historical significance in the local community. 
                The mosque serves as a spiritual and social center, bringing together people of faith 
                and providing essential religious services.`;
            }

            autoLocate() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const { latitude, longitude } = position.coords;
                            this.map.setView([latitude, longitude], 12);
                            
                            // Automatically search mosques near current location
                            this.map.panTo(new L.LatLng(latitude, longitude));
                            document.getElementById('cityInput').value = 'Current Location';
                            this.searchMosques();
                        },
                        (error) => {
                            console.error('Geolocation error:', error);
                            alert('Could not retrieve location');
                        }
                    );
                } else {
                    alert('Geolocation is not supported by your browser');
                }
            }
        }

        // Initialize the app
        const mosqueFinder = new MosqueFinder();
    </script>
</body>
</html>
