<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, AppleAuthProvider, signInWithPopup, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      // Your Firebase configuration details
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Check if the user is signing in with the email link
    if (isSignInWithEmailLink(auth, window.location.href)) {
      let email = localStorage.getItem('emailForSignIn');
      if (!email) {
        email = window.prompt('Please provide your email for confirmation');
      }
      signInWithEmailLink(auth, email, window.location.href)
        .then((result) => {
          // Remove the email from local storage
          localStorage.removeItem('emailForSignIn');
          // Get the user's profile information
          const user = result.user;
          handleUserProfile(user);
        })
        .catch((error) => {
          alert('Error signing in with email link: ' + error.message);
        });
    } else {
      // Add event listener to the Google sign-in button
      document.getElementById('google-login-button').addEventListener('click', () => {
        const provider = new GoogleAuthProvider();
        signInWithPopup(auth, provider)
          .then((result) => {
            handleUserProfile(result.user);
          })
          .catch((error) => {
            alert('Error signing in with Google: ' + error.message);
          });
      });

      // Add event listener to the Apple sign-in button
      document.getElementById('apple-login-button').addEventListener('click', () => {
        const provider = new AppleAuthProvider();
        signInWithPopup(auth, provider)
          .then((result) => {
            handleUserProfile(result.user);
          })
          .catch((error) => {
            alert('Error signing in with Apple: ' + error.message);
          });
      });

      // Add event listener to the email sign-in form
      document.getElementById('email-login-form').addEventListener('submit', (event) => {
        event.preventDefault();
        const email = document.getElementById('email').value;
        sendSignInLinkToEmail(auth, email, {
          url: window.location.href,
          handleCodeInApp: true
        })
        .then(() => {
          // Store the email in local storage
          localStorage.setItem('emailForSignIn', email);
          alert('Please check your email for the activation link.');
        })
        .catch((error) => {
          alert('Error sending activation link: ' + error.message);
        });
      });
    }

    function handleUserProfile(user) {
      const userDocRef = doc(db, "users", user.uid);
      getDoc(userDocRef)
        .then((userDoc) => {
          if (userDoc.exists()) {
            // Store the user's name and email in local storage
            localStorage.setItem("userName", userDoc.data().name);
            localStorage.setItem("userEmail", userDoc.data().email);
            // Redirect the user to the profile page
            window.location.href = 'profile.html';
          } else {
            // Create a new user document in Firestore
            userDocRef.set({
              name: user.displayName,
              email: user.email
            })
            .then(() => {
              // Store the user's name and email in local storage
              localStorage.setItem("userName", user.displayName);
              localStorage.setItem("userEmail", user.email);
              // Redirect the user to the profile page
              window.location.href = 'profile.html';
            })
            .catch((error) => {
              alert('Error saving user profile: ' + error.message);
            });
          }
        })
        .catch((error) => {
          if (error.code === 'unavailable') {
            // User is offline, use fallback data
            localStorage.setItem("userName", user.displayName);
            localStorage.setItem("userEmail", user.email);
            window.location.href = 'profile.html';
          } else {
            alert('Error getting user profile: ' + error.message);
          }
        });
    }
  </script>
</head>
<body>
  <h1>Login</h1>
  <button id="google-login-button">Sign in with Google</button>
  <button id="apple-login-button">Sign in with Apple</button>
  <hr>
  <h2>Or sign in with email</h2>
  <form id="email-login-form">
    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required>
    <br>
    <button type="submit">Send Activation Link</button>
  </form>
</body>
</html>
