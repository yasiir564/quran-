<!DOCTYPE html>
<html>
<head>
  <title>Login</title>
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, OAuthProvider, signInWithPopup, sendSignInLinkToEmail } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyCCHwRT-Nj3GfPZD-If2P7iMajPjAB9RJA",
      authDomain: "quran-pro-c1df1.firebaseapp.com",
      projectId: "quran-pro-c1df1",
      storageBucket: "quran-pro-c1df1.appspot.com",
      messagingSenderId: "782064856596",
      appId: "1:782064856596:web:3c11c7a0186a2923bac101",
      measurementId: "G-RFVGMM8VYQ"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Add event listener to the Google sign-in button
    document.getElementById('google-login-button').addEventListener('click', () => {
      const provider = new GoogleAuthProvider();
      signInWithPopup(auth, provider)
        .then((result) => {
          handleUserProfile(result.user);
        })
        .catch((error) => {
          alert('Error signing in with Google: ' + error.message);
        });
    });

    // Add event listener to the Apple sign-in button
    document.getElementById('apple-login-button').addEventListener('click', () => {
      const provider = new OAuthProvider('apple.com');
      signInWithPopup(auth, provider)
        .then((result) => {
          handleUserProfile(result.user);
        })
        .catch((error) => {
          alert('Error signing in with Apple: ' + error.message);
        });
    });

    // Add event listener to the email sign-in form
    document.getElementById('email-login-form').addEventListener('submit', (event) => {
      event.preventDefault();
      const email = document.getElementById('email').value;
      sendSignInLinkToEmail(auth, email, {
        url: window.location.href,
        handleCodeInApp: true
      })
      .then(() => {
        // Store the email in local storage
        localStorage.setItem('emailForSignIn', email);
        alert('Please check your email for the activation link.');
      })
      .catch((error) => {
        alert('Error sending activation link: ' + error.message);
      });
    });

    function handleUserProfile(user) {
      const userDocRef = doc(db, "users", user.uid);
      getDoc(userDocRef)
        .then((userDoc) => {
          if (userDoc.exists()) {
            // Store the user's name and email in local storage
            localStorage.setItem("userName", userDoc.data().name);
            localStorage.setItem("userEmail", userDoc.data().email);
            displayUserProfile(userDoc.data().name, userDoc.data().email, userDoc.data().avatar || null);
          } else {
            // Create a new user document in Firestore with default avatar
            const defaultAvatar = null;  // or use a default image URL
            setDoc(userDocRef, {
              name: user.displayName,
              email: user.email,
              avatar: defaultAvatar
            })
            .then(() => {
              // Store the user's name and email in local storage
              localStorage.setItem("userName", user.displayName);
              localStorage.setItem("userEmail", user.email);
              displayUserProfile(user.displayName, user.email, defaultAvatar);
            })
            .catch((error) => {
              alert('Error saving user profile: ' + error.message);
            });
          }
        })
        .catch((error) => {
          if (error.code === 'unavailable') {
            // User is offline, use fallback data
            const name = user.displayName;
            const email = user.email;
            localStorage.setItem("userName", name);
            localStorage.setItem("userEmail", email);
            displayUserProfile(name, email, null);
          } else {
            alert('Error getting user profile: ' + error.message);
          }
        });
    }

    function displayUserProfile(name, email, avatar) {
      const profileContainer = document.createElement('div');
      profileContainer.style.textAlign = 'center';
      profileContainer.style.marginTop = '20px';

      const avatarElement = document.createElement('div');
      avatarElement.style.width = '100px';
      avatarElement.style.height = '100px';
      avatarElement.style.borderRadius = '50%';
      avatarElement.style.backgroundColor = '#007bff';
      avatarElement.style.display = 'flex';
      avatarElement.style.alignItems = 'center';
      avatarElement.style.justifyContent = 'center';
      avatarElement.style.color = '#fff';
      avatarElement.style.fontSize = '50px';
      avatarElement.style.margin = '0 auto';

      if (avatar) {
        avatarElement.style.backgroundImage = `url(${avatar})`;
        avatarElement.style.backgroundSize = 'cover';
        avatarElement.style.backgroundPosition = 'center';
      } else {
        avatarElement.textContent = name.charAt(0).toUpperCase();
      }

      const nameElement = document.createElement('h2');
      nameElement.textContent = name;

      const emailElement = document.createElement('p');
      emailElement.textContent = email;

      profileContainer.appendChild(avatarElement);
      profileContainer.appendChild(nameElement);
      profileContainer.appendChild(emailElement);

      document.body.innerHTML = ''; // Clear the existing content
      document.body.appendChild(profileContainer);
    }
  </script>
</head>
<body>
  <h1>Login</h1>
  <button id="google-login-button">Sign in with Google</button>
  <button id="apple-login-button">Sign in with Apple</button>
  <hr>
  <h2>Or sign in with email</h2>
  <form id="email-login-form">
    <label for="email">Email:</label>
    <input type="email" id="email" name="email" required>
    <br>
    <button type="submit">Send Activation Link</button>
  </form>
</body>
</html>

