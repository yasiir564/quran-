<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prayer Times WorldWide - Accurate Salah Timings</title>
    <meta name="description" content="Find accurate Islamic prayer times based on your location. Get Salah timings for Fajr, Dhuhr, Asr, Maghrib, and Isha with this easy-to-use tool.">
    <meta name="keywords" content="Prayer Times, Salah Timings, Islamic Prayer Schedule, Fajr, Dhuhr, Asr, Maghrib, Isha, Muslim Prayer Tool, Ramadan Times, Suhur Time, Iftar Time, Sehri Time, Islamic Calendar, Taraweeh Prayers, Ramadan 2024, Ramadan Fasting, Islamic Fasting, Eid Prayer Timings">
     <link rel="icon" href="/tinywow_Quran pro_62044384.png" type="image/x-icon">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.lordicon.com/lordicon.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert2/11.7.32/sweetalert2.min.css">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1850217813586802"
     crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Event",
  "name": "Fajr Prayer Time in Nairobi",
  "startDate": "2025-03-08T05:15:00+03:00",
  "endDate": "2025-03-08T05:30:00+03:00",
  "eventAttendanceMode": "https://schema.org/OfflineEventAttendanceMode",
  "location": {
    "@type": "Place",
    "name": "Nairobi Central Mosque",
    "address": {
      "@type": "PostalAddress",
      "streetAddress": "Moi Avenue",
      "addressLocality": "Nairobi",
      "addressCountry": "KE"
    }
  },
  "description": "Fajr prayer time in Nairobi starts at 5:15 AM.",
  "performer": {
    "@type": "Person",
    "name": "Imam of Nairobi Central Mosque"
  }
}
</script>

    <style>
       :root {
    --gradient-start: #7f1bf2;
    --gradient-end: #9543f5;
    --accent-color: #7f1bf2;
    --accent-dark: #6813d0;
    --card-bg: rgba(255, 255, 255, 0.9);
    --primary-color: #7f1bf2;
}

html {
    scroll-behavior: smooth;
}

body {
    background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
    font-family: 'Tajawal', sans-serif;
    overflow-x: hidden;
}

.custom-gradient {
    background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
}

.prayer-time-card {
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    background: var(--card-bg);
    overflow: hidden;
    position: relative;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.prayer-time-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end));
    opacity: 0;
    transition: opacity 0.3s ease;
}

.prayer-time-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 15px 30px rgba(127, 27, 242, 0.25);
}

.prayer-time-card:hover::before {
    opacity: 1;
}

.prayer-time-card.active {
    border: 2px solid var(--accent-color);
    box-shadow: 0 10px 25px rgba(127, 27, 242, 0.3);
}

.prayer-time-card.active::before {
    opacity: 1;
    width: 6px;
}

.arabic {
    font-family: 'Tajawal', sans-serif;
    font-weight: 500;
}

.scrollbar {
    scrollbar-width: thin;
    scrollbar-color: var(--accent-color) rgba(240, 240, 240, 0.7);
}

.scrollbar::-webkit-scrollbar {
    width: 8px;
}

.scrollbar::-webkit-scrollbar-track {
    background: rgba(240, 240, 240, 0.7);
    border-radius: 10px;
}

.scrollbar::-webkit-scrollbar-thumb {
    background: var(--accent-color);
    border-radius: 10px;
}

.countdown {
    font-variant-numeric: tabular-nums;
}

.icon-float {
    animation: float 3s ease-in-out infinite;
    filter: drop-shadow(0 5px 15px rgba(127, 27, 242, 0.3));
}

@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
}

.nav-shine {
    position: relative;
    overflow: hidden;
}

.nav-shine::after {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
        to right,
        rgba(255, 255, 255, 0) 0%,
        rgba(255, 255, 255, 0.3) 50%,
        rgba(255, 255, 255, 0) 100%
    );
    transform: rotate(30deg);
    animation: shine 6s infinite linear;
}

@keyframes shine {
    from { transform: translateX(-100%) rotate(30deg); }
    to { transform: translateX(100%) rotate(30deg); }
}

@media (prefers-reduced-motion) {
    .icon-float, .nav-shine::after {
        animation: none;
    }
}

/* Dark Mode Toggle Animation */
.dark-mode-toggle {
  transition: transform 0.3s ease;
}

.dark-mode-toggle:hover {
  transform: rotate(30deg);
}

.dark-mode .dark-mode-toggle:hover {
  transform: rotate(-30deg);
}

/* Focus states for accessibility */
button:focus, select:focus {
  outline: 2px solid var(--primary-color);
  outline-offset: 2px;
}

/* Add prayer color accents for Muslim World League */
.method-mwl .prayer-time-card:nth-child(1) {
  border-top: 3px solid #7f1bf2;
}

.method-mwl .prayer-time-card:nth-child(2) {
  border-top: 3px solid #9543f5;
}

.method-mwl .prayer-time-card:nth-child(3) {
  border-top: 3px solid #7f1bf2;
}

.method-mwl .prayer-time-card:nth-child(4) {
  border-top: 3px solid #9543f5;
}

.method-mwl .prayer-time-card:nth-child(5) {
  border-top: 3px solid #7f1bf2;
}

.method-mwl .prayer-time-card:nth-child(6) {
  border-top: 3px solid #9543f5;
}

/* AdSense Container Styles */
.ad-container {
    width: 100%;
    margin: 1rem 0 2rem 0;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100px;
    background-color: rgba(255, 255, 255, 0.7);
    border-radius: 0.5rem;
    overflow: hidden;
    backdrop-filter: blur(5px);
    transition: all 0.3s ease;
    border: 1px solid rgba(127, 27, 242, 0.1);
}

.ad-container ins {
    display: block;
    width: 100%;
    text-align: center;
}

@media (max-width: 768px) {
    .ad-container {
        margin: 1rem 0 1.5rem 0;
    }
}

/* SIDEBAR STYLES */
.sidebar {
    height: 100vh;
    width: 280px;
    position: fixed;
    z-index: 1000;
    top: 0;
    left: -280px;
    background: linear-gradient(135deg, #7f1bf2, #9543f5);
    overflow-x: hidden;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    padding-top: 85px;
    box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-right: 1px solid rgba(255, 255, 255, 0.1);
}

.sidebar.open {
    left: 0;
    box-shadow: 0 0 50px rgba(127, 27, 242, 0.3);
}

.sidebar a {
    padding: 14px 24px;
    text-decoration: none;
    font-size: 16px;
    color: rgba(255, 255, 255, 0.9);
    display: flex;
    align-items: center;
    gap: 12px;
    transition: all 0.3s ease;
    border-radius: 0 25px 25px 0;
    margin: 4px 0;
    margin-right: 16px;
    font-weight: 500;
}

.sidebar a:hover {
    color: #ffffff;
    background-color: rgba(255, 255, 255, 0.1);
    transform: translateX(8px);
}

.sidebar a.active {
    background-color: rgba(255, 255, 255, 0.2);
    color: #ffffff;
}

.sidebar .closebtn {
    position: absolute;
    top: 20px;
    right: 25px;
    font-size: 28px;
    color: rgba(255, 255, 255, 0.8);
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    margin: 0;
    padding: 0;
}

.sidebar .closebtn:hover {
    background-color: rgba(255, 255, 255, 0.1);
    transform: rotate(90deg);
}

.sidebar-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 999;
    backdrop-filter: blur(3px);
    transition: all 0.3s ease;
}

.sidebar-overlay.active {
    display: block;
}

.openbtn {
    font-size: 18px;
    cursor: pointer;
    background-color: #7f1bf2;
    color: white;
    padding: 12px 20px;
    border: none;
    position: fixed;
    top: 40px;
    left: 20px;
    z-index: 1000;
    border-radius: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(127, 27, 242, 0.3);
}

.openbtn:hover {
    background-color: #6813d0;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(127, 27, 242, 0.4);
}

#main {
    transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 20px;
}

@media screen and (max-width: 768px) {
    .sidebar {
        width: 100%;
        left: -100%;
    }
    
    .openbtn {
        top: 20px;
        left: 20px;
    }
}

@media screen and (max-height: 450px) {
    .sidebar {
        padding-top: 60px;
    }
    
    .sidebar a {
        font-size: 16px;
        padding: 10px 20px;
    }
}
        /* Benefits Section Styles */
.benefits-section {
    position: relative;
    overflow: hidden;
}

.benefits-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 400px;
    background: linear-gradient(180deg, rgba(127, 27, 242, 0.05) 0%, rgba(255, 255, 255, 0) 100%);
    z-index: -1;
}

.benefits-title {
    background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    display: inline-block;
}

.benefit-card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
}

.benefit-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 4px;
    background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s ease;
}

.benefit-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 40px rgba(127, 27, 242, 0.15);
}

.benefit-card:hover::after {
    transform: scaleX(1);
}

.benefit-icon-wrapper {
    margin-bottom: 1.5rem;
    background: rgba(127, 27, 242, 0.05);
    border-radius: 50%;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
}

.benefit-card:hover .benefit-icon-wrapper {
    transform: scale(1.1);
    background: rgba(127, 27, 242, 0.1);
}

.benefit-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: #333;
    font-family: 'Tajawal', sans-serif;
    text-align: center;
}

.benefit-description {
    color: #666;
    line-height: 1.6;
    font-size: 1rem;
    text-align: center;
}

/* Dark Mode Styles */
@media (prefers-color-scheme: dark) {
    .benefit-card {
        background: rgba(30, 30, 40, 0.8);
        border-color: rgba(127, 27, 242, 0.2);
    }
    
    .benefit-title {
        color: #fff;
    }
    
    .benefit-description {
        color: #ccc;
    }
    
    .benefits-section::before {
        background: linear-gradient(180deg, rgba(127, 27, 242, 0.1) 0%, rgba(30, 30, 40, 0) 100%);
    }
}

/* Responsive Adjustments */
@media (max-width: 768px) {
    .benefit-card {
        padding: 1.5rem;
    }
    
    .benefit-icon-wrapper {
        width: 60px;
        height: 60px;
    }
    
    .benefit-title {
        font-size: 1.1rem;
    }
    
    .benefit-description {
        font-size: 0.9rem;
    }
}
    </style>
</head>
    <div id="prayer-times-link">
    <p>Loading prayer times...</p>
</div>

     <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div id="mySidebar" class="sidebar">
        <a href="javascript:void(0)" class="closebtn" id="closeSidebarBtn">&times;</a>
        <a href="index.html">
            <lord-icon src="https://cdn.lordicon.com/jvucoldz.json" trigger="hover" colors="primary:#ffffff,secondary:#08a88a" style="width:50px;height:50px"></lord-icon> Read Quran
        </a>
        <a href="read-quran-by-juzz.html">
            <lord-icon src="https://cdn.lordicon.com/hpivxauj.json" trigger="hover" colors="primary:#ffffff,secondary:#08a88a" style="width:50px;height:50px"></lord-icon> Read in Juzz
        </a>
        <a href="tracks.html">
            <lord-icon src="https://cdn.lordicon.com/wxnxiano.json" trigger="hover" colors="primary:#ffffff,secondary:#08a88a" style="width:50px;height:50px"></lord-icon> Listen to Quran
        </a>
        <a href="prayer-times.html">
            <lord-icon src="https://cdn.lordicon.com/tftaqjwp.json" trigger="hover" colors="primary:#ffffff,secondary:#08a88a" style="width:50px;height:50px"></lord-icon> prayer Time
        </a>
        <a href="donate.html">
            <lord-icon src="https://cdn.lordicon.com/rjzlnunf.json" trigger="hover" colors="primary:#ffffff,secondary:#08a88a" style="width:50px;height:50px"></lord-icon> Donate with love
        </a>
    </div>

    <div id="main">
        <button class="openbtn" id="openSidebarBtn">&#9776; Quran Pro</button>
<body class="min-h-screen pb-8 scrollbar">
    <!-- Navigation -->
    <nav class="custom-gradient shadow-lg text-white sticky top-0 z-50 nav-shine">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3 animate__animated animate__fadeInLeft">
                    <lord-icon
                        src="https://cdn.lordicon.com/xnwbsupk.json"
                        trigger="loop"
                        colors="primary:#ffffff"
                        style="width:40px;height:40px">
                    </lord-icon>
                    <h1 class="text-2xl font-bold">Prayer Times | أوقات الصلاة</h1>
                </div>
                <div class="flex items-center space-x-4 animate__animated animate__fadeInRight">
                    <div id="current-date" class="text-white font-medium hidden md:block"></div>
                    <div id="location-display" class="text-white font-semibold bg-indigo-700 px-3 py-1 rounded-full text-sm flex items-center">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        <span>Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-4 py-8">
        <!-- Next Prayer Counter -->
        <div class="bg-white bg-opacity-90 rounded-2xl shadow-xl p-6 mb-8 transform transition-all duration-500 animate__animated animate__fadeInUp backdrop-filter backdrop-blur-md border border-indigo-100">
            <div class="flex flex-col md:flex-row items-center justify-between">
                <div class="flex items-center mb-4 md:mb-0">
                    <lord-icon
                        src="https://cdn.lordicon.com/osvvqecf.json"
                        trigger="loop"
                        colors="primary:#6366f1,secondary:#8b5cf6"
                        style="width:64px;height:64px" class="icon-float">
                    </lord-icon>
                    <div class="ml-4">
                        <h2 class="text-2xl font-bold text-indigo-600">Next Prayer | الصلاة القادمة</h2>
                        <p id="next-prayer-name" class="text-lg text-gray-600 flex flex-col md:flex-row">
                            <span class="mr-2">Loading...</span>
                            <span class="arabic mr-2">جاري التحميل...</span>
                        </p>
                    </div>
                </div>
                <div class="text-center">
                    <div id="time-remaining" class="countdown text-4xl font-bold text-indigo-600">--:--:--</div>
                    <p class="text-gray-500 text-sm">Time Remaining | الوقت المتبقي</p>
                </div>
            </div>
        </div>

      <!-- AdSense Ad Container -->
<div class="ad-container animate__animated animate__fadeIn">
    <ins class="adsbygoogle"
         style="display:block; text-align:center;"
         data-ad-layout="in-article"
         data-ad-format="fluid"
         data-ad-client="ca-pub-1850217813586802"
         data-ad-slot="1343025343"></ins>
    <script>
         (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>

        <!-- Prayer Times Grid -->
        <div id="prayer-times" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <!-- Prayer cards will be inserted here by JavaScript -->
        </div>
    </main>
     <!-- AdSense Ad Container -->
<div class="ad-container animate__animated animate__fadeIn" style="text-align:center; margin: 10px 0;">
    <ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-1850217813586802"
     data-ad-slot="1454600783"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
</div>

    <!-- Benefits of Prayer Section -->
<section id="benefits" class="benefits-section py-16">
    <div class="container mx-auto px-4">
        <div class="text-center mb-12">
            <h2 class="text-3xl font-bold mb-3 benefits-title">Benefits of Prayer</h2>
            <div class="w-24 h-1 custom-gradient mx-auto rounded-full"></div>
            <p class="mt-4 text-gray-600 dark:text-gray-300 max-w-2xl mx-auto">Discover how regular prayer can transform your life spiritually, mentally, and physically.</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <!-- Benefit Card 1 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/tdxypxgp.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Spiritual Connection</h3>
                <p class="benefit-description">Prayer creates a direct connection with Allah, strengthening your faith and bringing you closer to divine guidance.</p>
            </div>

            <!-- Benefit Card 2 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/nkmsrxys.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Mental Peace</h3>
                <p class="benefit-description">Regular prayer reduces anxiety and stress, promoting mental clarity and emotional balance in your daily life.</p>
            </div>

            <!-- Benefit Card 3 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/cjieiyzp.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Physical Well-being</h3>
                <p class="benefit-description">The movements in prayer serve as a form of gentle exercise, improving flexibility, posture, and overall physical health.</p>
            </div>

            <!-- Benefit Card 4 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/zpxybbhl.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Community Building</h3>
                <p class="benefit-description">Congregational prayers foster a sense of unity and brotherhood, strengthening community bonds and social support.</p>
            </div>

            <!-- Benefit Card 5 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/dycatgju.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Inner Discipline</h3>
                <p class="benefit-description">Maintaining regular prayer times helps develop self-discipline and structure that extends to other areas of your life.</p>
            </div>

            <!-- Benefit Card 6 -->
            <div class="benefit-card">
                <div class="benefit-icon-wrapper">
                    <lord-icon
                        src="https://cdn.lordicon.com/rqqkvjqf.json"
                        trigger="hover"
                        colors="primary:#7f1bf2,secondary:#9543f5"
                        style="width:64px;height:64px">
                    </lord-icon>
                </div>
                <h3 class="benefit-title">Life Perspective</h3>
                <p class="benefit-description">Prayer reminds us of our purpose and helps maintain perspective, placing worldly concerns in their proper context.</p>
            </div>
        </div>
    </div>
</section>

    <!-- Footer -->
    <footer class="mt-12 pt-8 pb-6 text-center text-gray-500">
        <div class="flex justify-center mb-4">
            <lord-icon
                src="https://cdn.lordicon.com/dnmvmpfk.json"
                trigger="hover"
                colors="primary:#6366f1"
                style="width:48px;height:48px">
            </lord-icon>
        </div>
        <p>Prayer Times Tool &copy; 2025 | Accurate Islamic Prayer Times</p>
    </footer>
    <script>
 document.addEventListener('DOMContentLoaded', function() {
    function openNav() {
        document.getElementById("mySidebar").classList.add("open");
        document.getElementById("sidebarOverlay").classList.add("active");
    }

    function closeNav() {
        document.getElementById("mySidebar").classList.remove("open");
        document.getElementById("sidebarOverlay").classList.remove("active");
    }

    document.getElementById('openSidebarBtn').addEventListener('click', openNav);
    document.getElementById('closeSidebarBtn').addEventListener('click', closeNav);
    document.getElementById('sidebarOverlay').addEventListener('click', closeNav);

    let lastScrollTop = 0;
    const header = document.querySelector('header');
    const sidebar = document.getElementById('mySidebar');
    let scrollTimeout;

    function applyScrollEffects() {
        const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;

        if (currentScrollTop > lastScrollTop) {
            header.classList.remove('header-visible');
            header.classList.add('header-hidden');
            sidebar.classList.add('blur-effect');
        } else {
            header.classList.remove('header-hidden');
            header.classList.add('header-visible');
            sidebar.classList.remove('blur-effect');
        }

        lastScrollTop = currentScrollTop <= 0 ? 0 : currentScrollTop;

        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            header.classList.remove('header-hidden');
            header.classList.add('header-visible');
            sidebar.classList.remove('blur-effect');
        }, 200);
    }

    window.addEventListener('scroll', applyScrollEffects);
});

      // Adhan recitation options by sheikhs
const adhanOptions = [
  { id: 'sheikh-ali-mulla', name: 'Sheikh Ali Ahmed Mulla', audio: 'https://cdn.islamic.network/adhans/ali-mulla.mp3' },
  { id: 'sheikh-abdullah-basfar', name: 'Sheikh Abdullah Basfar', audio: 'https://cdn.islamic.network/adhans/basfar.mp3' },
  { id: 'sheikh-abd-basit', name: 'Sheikh Abdul Basit', audio: 'https://cdn.islamic.network/adhans/abd-basit.mp3' },
  { id: 'sheikh-al-minshawi', name: 'Sheikh Al-Minshawi', audio: 'https://cdn.islamic.network/adhans/minshawi.mp3' }
];

// Store notification settings
let notificationSettings = {};

// Audio player for adhan
let adhanAudio = null;

// Prayer names in Arabic
const prayerNamesArabic = {
    Fajr: 'الفجر',
    Sunrise: 'الشروق',
    Dhuhr: 'الظهر',
    Asr: 'العصر',
    Maghrib: 'المغرب',
    Isha: 'العشاء'
};

// Prayer descriptions in Arabic
const prayerDescArabic = {
    Fajr: 'صلاة الفجر',
    Sunrise: 'شروق الشمس',
    Dhuhr: 'صلاة الظهر',
    Asr: 'صلاة العصر',
    Maghrib: 'صلاة المغرب',
    Isha: 'صلاة العشاء'
};

// Lord icon sources for each prayer time
const prayerIcons = {
    Fajr: 'https://cdn.lordicon.com/spgozyor.json',
    Sunrise: 'https://cdn.lordicon.com/qtedxnsm.json',
    Dhuhr: 'https://cdn.lordicon.com/oaflahpk.json',
    Asr: 'https://cdn.lordicon.com/uqpazftn.json',
    Maghrib: 'https://cdn.lordicon.com/wxnxiano.json',
    Isha: 'https://cdn.lordicon.com/udwhdpod.json'
};

// Color schemes for each prayer
const prayerColors = {
    Fajr: ['#6366f1', '#9333ea'],
    Sunrise: ['#f59e0b', '#d97706'],
    Dhuhr: ['#3b82f6', '#1d4ed8'],
    Asr: ['#10b981', '#065f46'],
    Maghrib: ['#ef4444', '#b91c1c'],
    Isha: ['#6366f1', '#4338ca']
};

// Default calculation methods - simplified
const CALCULATION_METHOD = { id: 3, name: 'Muslim World League' };
const ASR_JURISTIC_METHOD = 0; // 0 for Shafi'i

// Global variable to store the countdown timer
let countdownTimer = null;

// Current position
let currentPosition = {
    latitude: null,
    longitude: null
};

// Track active notifications to prevent duplicates
let activeNotifications = {};

// App favicon URL
const APP_FAVICON = '/favicon.ico';

// Service worker registration
let swRegistration = null;

// ======================== API INTEGRATION ======================== //

// Fetch prayer times from API
async function fetchPrayerTimes(latitude, longitude, date) {
    try {
        updateLoadingState(true, 'Fetching prayer times...');
        
        // Format date as YYYY-MM-DD
        const formattedDate = date.toISOString().split('T')[0];
        
        // Create API URL with parameters - fixed URL construction
        const url = new URL('https://api.aladhan.com/v1/timings');
        url.search = new URLSearchParams({
            latitude: latitude,
            longitude: longitude,
            method: CALCULATION_METHOD.id,
            adjustment: 0,
            tune: "0,0,0,0,0,0,0,0,0",
            school: ASR_JURISTIC_METHOD,
            date: formattedDate
        });
        
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`API Error: ${response.status}`);
        }
        
        const data = await response.json();
        updateLoadingState(false);
        
        if (data.code === 200 && data.data && data.data.timings) {
            return formatPrayerTimesFromAPI(data.data.timings);
        } else {
            throw new Error('Invalid data format received from API');
        }
    } catch (error) {
        updateLoadingState(false);
        console.error('Error fetching prayer times:', error);
        
        // Show error using SweetAlert instead of standard alert
        Swal.fire({
            title: 'Error!',
            text: 'Failed to fetch prayer times. Please try again later.',
            icon: 'error',
            confirmButtonText: 'OK',
            confirmButtonColor: '#6366f1'
        });
        
        // Return empty times
        return {
            Fajr: "-----",
            Sunrise: "-----",
            Dhuhr: "-----",
            Asr: "-----",
            Maghrib: "-----",
            Isha: "-----"
        };
    }
}

// Format times from API to match our format
function formatPrayerTimesFromAPI(timings) {
    // Convert API response to our format and convert to 12-hour format
    return {
        Fajr: convertTo12HourFormat(timings.Fajr),
        Sunrise: convertTo12HourFormat(timings.Sunrise),
        Dhuhr: convertTo12HourFormat(timings.Dhuhr),
        Asr: convertTo12HourFormat(timings.Asr),
        Maghrib: convertTo12HourFormat(timings.Maghrib),
        Isha: convertTo12HourFormat(timings.Isha)
    };
}

// Convert time from 24-hour format to 12-hour format
function convertTo12HourFormat(timeStr) {
    if (!timeStr || timeStr === "-----") return "-----";
    
    const [hours24, minutes] = timeStr.split(':').map(Number);
    
    if (isNaN(hours24) || isNaN(minutes)) return "-----";
    
    const period = hours24 >= 12 ? 'PM' : 'AM';
    const hours12 = hours24 % 12 || 12;
    
    return `${hours12.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')} ${period}`;
}

// ======================== FORMATTING FUNCTIONS ======================== //

// Format time string to Arabic numerals
function formatTimeArabic(timeStr) {
    if (timeStr === "-----") return "-----";
    
    // Convert to 24-hour format first
    const [time, period] = timeStr.split(' ');
    let [hours, minutes] = time.split(':').map(Number);
    
    if (period === 'PM' && hours !== 12) hours += 12;
    if (period === 'AM' && hours === 12) hours = 0;
    
    // Format with Arabic numerals
    const arabicDigits = ['٠', '١', '٢', '٣', '٤', '٥', '٦', '٧', '٨', '٩'];
    const hoursStr = hours.toString().padStart(2, '0').split('').map(d => arabicDigits[parseInt(d)]).join('');
    const minutesStr = minutes.toString().padStart(2, '0').split('').map(d => arabicDigits[parseInt(d)]).join('');
    
    return `${hoursStr}:${minutesStr}`;
}

// Convert time string to Date object for comparison
function convertTimeStringToDate(timeStr, useNextDay = false) {
    if (timeStr === "-----") return null;
    
    const today = new Date();
    const [time, period] = timeStr.split(' ');
    let [hours, minutes] = time.split(':').map(Number);
    
    if (period === 'PM' && hours !== 12) hours += 12;
    if (period === 'AM' && hours === 12) hours = 0;
    
    const result = new Date(today.getFullYear(), today.getMonth(), today.getDate() + (useNextDay ? 1 : 0), hours, minutes);
    return result;
}

// ======================== UI UPDATE FUNCTIONS ======================== //

// Safely get DOM element with fallback
function safeGetElement(id, fallback = null) {
    const element = document.getElementById(id);
    if (!element && fallback) {
        console.warn(`Element with ID '${id}' not found, creating it`);
        const newElement = document.createElement(fallback);
        newElement.id = id;
        
        // Make sure document.body exists before appending
        if (document.body) {
            document.body.appendChild(newElement);
            return newElement;
        } else {
            console.error('Document body not available for appending element');
            return null;
        }
    }
    return element;
}

// Display the prayer times in the UI
function displayPrayerTimes(times) {
    const container = safeGetElement('prayer-times', 'div');
    if (!container) {
        console.error('Prayer times container not found and could not be created');
        return;
    }
    
    container.innerHTML = '';

    const prayers = {
        Fajr: ['Dawn Prayer', 'fa-sun'],
        Sunrise: ['Sunrise', 'fa-sun'],
        Dhuhr: ['Noon Prayer', 'fa-sun'],
        Asr: ['Afternoon Prayer', 'fa-cloud-sun'],
        Maghrib: ['Sunset Prayer', 'fa-moon'],
        Isha: ['Night Prayer', 'fa-star']
    };

    const currentTime = new Date();
    let nextPrayer = null;
    let nextPrayerTime = null;

    // First determine the next prayer
    Object.entries(prayers).forEach(([prayer, [label, icon]]) => {
        if (times[prayer] === "-----") return;
        
        const prayerDate = convertTimeStringToDate(times[prayer]);
        
        if (prayerDate && prayerDate > currentTime && (!nextPrayerTime || prayerDate < nextPrayerTime)) {
            nextPrayer = prayer;
            nextPrayerTime = prayerDate;
        }
    });

    // Handle case where all prayers have passed for the day
    if (!nextPrayer) {
        // Let the user know that we'll show tomorrow's times for Fajr
        const nextPrayerNameElement = safeGetElement('next-prayer-name', 'div');
        if (nextPrayerNameElement) {
            nextPrayerNameElement.innerHTML = `
                <span class="mr-2">All prayers passed for today. Showing countdown to tomorrow's Fajr</span>
                <span class="arabic mr-2">انتهت جميع الصلوات لهذا اليوم. عرض العد التنازلي لصلاة الفجر غدًا</span>
            `;
        }
        
        // Fetch tomorrow's times for Fajr
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        fetchPrayerTimes(
            currentPosition.latitude, 
            currentPosition.longitude, 
            tomorrow
        ).then(tomorrowTimes => {
            if (tomorrowTimes.Fajr !== "-----") {
                nextPrayer = 'Fajr';
                
                // Use true to indicate this is for tomorrow
                const fajrTime = convertTimeStringToDate(tomorrowTimes.Fajr, true);
                
                if (fajrTime) {
                    nextPrayerTime = fajrTime;
                    updateCountdown(nextPrayerTime);
                    
                    // Store tomorrow's Fajr time for notifications
                    storeNextDayPrayer('Fajr', tomorrowTimes.Fajr);
                }
            }
        }).catch(error => {
            console.error("Error fetching tomorrow's prayer times:", error);
            const timeRemainingElement = safeGetElement('time-remaining', 'div');
            if (timeRemainingElement) {
                timeRemainingElement.textContent = "--:--:--";
            }
        });
    }

    // Now create cards
    Object.entries(prayers).forEach(([prayer, [label, icon]], index) => {
        const isActive = prayer === nextPrayer;
        const [primary, secondary] = prayerColors[prayer] || ['#6366f1', '#8b5cf6'];
        
        const card = document.createElement('div');
        card.className = `prayer-time-card rounded-xl shadow-lg p-6 animate__animated animate__fadeIn animate__delay-${index % 5}s ${isActive ? 'active' : ''}`;
        if (isActive) {
            card.style.background = `linear-gradient(145deg, ${primary}15, ${secondary}15)`;
        }
        
        card.innerHTML = `
            <div class="flex items-center justify-between mb-3">
                <div>
                    <h3 class="text-xl font-bold ${isActive ? 'text-indigo-700' : 'text-indigo-600'}">${label}</h3>
                    <p class="text-gray-600">${prayer} | ${prayerNamesArabic[prayer]}</p>
                </div>
                <lord-icon
                    src="${prayerIcons[prayer]}"
                    trigger="hover"
                    colors="primary:${primary},secondary:${secondary}"
                    style="width:48px;height:48px">
                </lord-icon>
            </div>
            <div class="flex items-center justify-between mt-4">
                <div class="flex flex-col">
                    <span class="text-sm text-gray-500">English</span>
                    <span class="text-lg font-semibold ${isActive ? 'text-indigo-700' : 'text-gray-700'}">${times[prayer]}</span>
                </div>
                <div class="flex flex-col items-end">
                    <span class="text-sm text-gray-500">عربي</span>
                    <span dir="rtl" class="text-lg font-semibold arabic ${isActive ? 'text-indigo-700' : 'text-gray-700'}">${formatTimeArabic(times[prayer])}</span>
                </div>
            </div>
            <div class="mt-4 flex justify-between items-center">
                ${isActive ? '<div class="text-xs text-indigo-600 font-medium">Next Prayer</div>' : ''}
                <button class="get-notified-btn text-xs px-3 py-1.5 rounded bg-indigo-600 text-white hover:bg-indigo-700 transition-colors" 
                        data-prayer="${prayer}">
                    <i class="fas fa-bell mr-1"></i> ${notificationSettings[prayer] ? 'Notification On' : 'Get Notified'}
                </button>
            </div>
        `;
        container.appendChild(card);
    });

    // Add event listeners to notification buttons
    document.querySelectorAll('.get-notified-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const prayer = this.getAttribute('data-prayer');
            showNotificationSettings(prayer, times[prayer]);
        });
    });

    // Update next prayer information
    if (nextPrayer && nextPrayerTime) {
        const nextPrayerNameElement = safeGetElement('next-prayer-name', 'div');
        if (nextPrayerNameElement) {
            nextPrayerNameElement.innerHTML = `
                <span class="mr-2">${prayers[nextPrayer][0]} (${nextPrayer})</span>
                <span class="arabic mr-2">${prayerDescArabic[nextPrayer]} (${prayerNamesArabic[nextPrayer]})</span>
            `;
        }
        updateCountdown(nextPrayerTime);
    }
}

// Store prayer time for next day
function storeNextDayPrayer(prayer, timeStr) {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];
    
    // Store in localStorage
    const nextDayPrayers = JSON.parse(localStorage.getItem('nextDayPrayers') || '{}');
    nextDayPrayers[tomorrowStr] = nextDayPrayers[tomorrowStr] || {};
    nextDayPrayers[tomorrowStr][prayer] = timeStr;
    
    localStorage.setItem('nextDayPrayers', JSON.stringify(nextDayPrayers));
}

// Update the countdown timer
function updateCountdown(targetTime) {
    if (!targetTime) return;
    
    const timeRemainingElement = safeGetElement('time-remaining', 'div');
    if (!timeRemainingElement) {
        console.error('Time remaining element not found and could not be created');
        return;
    }
    
    // Clear any existing timer before starting a new one
    if (countdownTimer) {
        clearTimeout(countdownTimer);
        countdownTimer = null;
    }
    
    const updateTimer = () => {
        const now = new Date();
        const diff = targetTime - now;
        
        if (diff <= 0) {
            timeRemainingElement.textContent = "00:00:00";
            // Refresh the page calculations when time is up
            setTimeout(() => {
                refreshPrayerTimes();
            }, 1000);
            return;
        }
        
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        timeRemainingElement.textContent = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Update every second
        countdownTimer = setTimeout(updateTimer, 1000);
    };
    
    updateTimer();
}

// ======================== NOTIFICATION FUNCTIONS ======================== //

// Check if browser supports notifications
function checkNotificationSupport() {
    if (!('Notification' in window)) {
        Swal.fire({
            title: 'Notifications Not Available',
            text: 'This browser does not support notifications',
            icon: 'error',
            confirmButtonText: 'OK',
            confirmButtonColor: '#6366f1'
        });
        return false;
    }
    return true;
}

// Request notification permission
async function requestNotificationPermission() {
    if (!checkNotificationSupport()) return false;
    
    if (Notification.permission === 'granted') {
        return true;
    }
    
    try {
        const permission = await Notification.requestPermission();
        return permission === 'granted';
    } catch (error) {
        console.error('Error requesting notification permission:', error);
        return false;
    }
}

// Register service worker for advanced notification features
async function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
        try {
            swRegistration = await navigator.serviceWorker.register('/sw.js');
            console.log('Service Worker registered successfully:', swRegistration);
            return true;
        } catch (error) {
            console.error('Service Worker registration failed:', error);
            return false;
        }
    } else {
        console.warn('Service Worker not supported in this browser');
        return false;
    }
}

// Show notification settings dialog
async function showNotificationSettings(prayer, prayerTime) {
    // Check if notification is supported and permission is granted
    const permissionGranted = await requestNotificationPermission();
    
    if (!permissionGranted) {
        Swal.fire({
            title: 'Permission Required',
            text: 'Please allow notifications to receive prayer time alerts',
            icon: 'warning',
            confirmButtonText: 'OK',
            confirmButtonColor: '#6366f1'
        });
        return;
    }
    
    // Try to register service worker for better notification handling
    registerServiceWorker();
    
    // Build adhan options HTML
    const adhanOptionsHtml = adhanOptions.map(option => `
        <div class="adhan-option flex items-center p-2 rounded hover:bg-indigo-50 cursor-pointer">
            <input type="radio" name="adhan-option" id="${option.id}" value="${option.id}" 
                   ${notificationSettings[prayer]?.adhanId === option.id ? 'checked' : ''}>
            <label for="${option.id}" class="ml-2 cursor-pointer flex-grow">${option.name}</label>
            <button class="preview-adhan text-xs px-2 py-1 rounded bg-indigo-100 text-indigo-700 hover:bg-indigo-200" 
                    data-audio="${option.audio}">
                <i class="fas fa-play"></i> Preview
            </button>
        </div>
    `).join('');
    
    // Show SweetAlert with adhan options
    const result = await Swal.fire({
        title: `${prayer} Notification Settings`,
        html: `
            <div class="mb-4">
                <p class="text-left mb-2">Select Adhan Recitation:</p>
                <div class="adhan-options-container max-h-60 overflow-y-auto">
                    ${adhanOptionsHtml}
                </div>
            </div>
            <div class="notification-options mt-4 text-left">
                <div class="mb-2">
                    <input type="checkbox" id="notify-before" ${notificationSettings[prayer]?.notifyBefore ? 'checked' : ''}>
                    <label for="notify-before">Notify 10 minutes before prayer time</label>
                </div>
                <div>
                    <input type="checkbox" id="play-adhan" ${notificationSettings[prayer]?.playAdhan ? 'checked' : ''} checked>
                    <label for="play-adhan">Play Adhan at prayer time</label>
                </div>
                <div class="mt-2">
                    <input type="checkbox" id="vibrate-device" ${notificationSettings[prayer]?.vibrateDevice ? 'checked' : ''} checked>
                    <label for="vibrate-device">Vibrate device (mobile only)</label>
                </div>
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Save Settings',
        cancelButtonText: 'Cancel',
        confirmButtonColor: '#6366f1',
        didOpen: () => {
            // Add event listeners to preview buttons
            document.querySelectorAll('.preview-adhan').forEach(btn => {
                btn.addEventListener('click', function() {
                    previewAdhan(this.getAttribute('data-audio'));
                });
            });
            
            // Auto-select first option if none selected
            if (!document.querySelector('input[name="adhan-option"]:checked')) {
                const firstOption = document.querySelector('input[name="adhan-option"]');
                if (firstOption) firstOption.checked = true;
            }
        }
    });
    
    if (result.isConfirmed) {
        // Get selected options
        const selectedAdhan = document.querySelector('input[name="adhan-option"]:checked');
        const notifyBefore = document.getElementById('notify-before').checked;
        const playAdhan = document.getElementById('play-adhan').checked;
        const vibrateDevice = document.getElementById('vibrate-device').checked;
        
        if (!selectedAdhan) {
            Swal.fire({
                title: 'Selection Required',
                text: 'Please select an Adhan recitation',
                icon: 'warning',
                confirmButtonText: 'OK',
                confirmButtonColor: '#6366f1'
            });
            return;
        }
        
        // Save notification settings
        const adhanId = selectedAdhan.value;
        const adhanOption = adhanOptions.find(option => option.id === adhanId);
        
        notificationSettings[prayer] = {
            adhanId,
            adhanUrl: adhanOption.audio,
            adhanName: adhanOption.name,
            notifyBefore,
            playAdhan,
            vibrateDevice,
            prayerTime
        };
        
        // Save to localStorage
        localStorage.setItem('prayerNotifications', JSON.stringify(notificationSettings));
        
        // Schedule notification
        scheduleNotification(prayer);
        
        // Update button text
        const notifyBtn = document.querySelector(`.get-notified-btn[data-prayer="${prayer}"]`);
        if (notifyBtn) {
            notifyBtn.innerHTML = '<i class="fas fa-bell mr-1"></i> Notification On';
        }
        
        // Show confirmation
        Swal.fire({
            title: 'Notification Set',
            text: `You will be notified for ${prayer} prayer time`,
            icon: 'success',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });
    }
}

// Preview adhan audio
function previewAdhan(audioUrl) {
    // Stop any playing audio
    if (adhanAudio) {
        adhanAudio.pause();
        adhanAudio = null;
    }
    
    // Create audio context for better mobile support
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // Play the selected adhan
    adhanAudio = new Audio(audioUrl);
    adhanAudio.volume = 0.5;
    
    // Create media element source
    const source = audioContext.createMediaElementSource(adhanAudio);
    source.connect(audioContext.destination);
    
    // Add controls to stop preview
    Swal.fire({
        title: 'Adhan Preview',
        html: `
            <div class="text-center">
                <p class="mb-4">Playing adhan preview...</p>
                <div class="flex justify-center space-x-4">
                    <button id="stop-adhan" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                        <i class="fas fa-stop mr-1"></i> Stop
                    </button>
                    <button id="adjust-volume" class="px-4 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600">
                        <i class="fas fa-volume-up mr-1"></i> Volume
                    </button>
                </div>
            </div>
        `,
        showConfirmButton: false,
        showCancelButton: false,
        willClose: () => {
            if (adhanAudio) {
                adhanAudio.pause();
                adhanAudio = null;
            }
        },
        didOpen: () => {
            // Resume audio context (needed for Chrome)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            adhanAudio.play().catch(error => {
                console.error('Error playing adhan preview:', error);
                Swal.fire({
                    title: 'Playback Error',
                    text: 'Could not play the adhan. Please try again or select another recitation.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#6366f1'
                });
            });
            
            // Add event listener to stop button
            document.getElementById('stop-adhan').addEventListener('click', () => {
                if (adhanAudio) {
                    adhanAudio.pause();
                    adhanAudio = null;
                }
                Swal.close();
            });
            
            // Add event listener to volume button
            document.getElementById('adjust-volume').addEventListener('click', () => {
                if (!adhanAudio) return;
                
                // Show volume slider
                Swal.fire({
                    title: 'Adjust Volume',
                    html: `
                        <input type="range" id="volume-slider" min="0" max="100" value="${adhanAudio.volume * 100}" 
                               class="w-full">
                        <div class="text-center mt-2" id="volume-value">${Math.round(adhanAudio.volume * 100)}%</div>
                    `,
                    confirmButtonText: 'Done',
                    confirmButtonColor: '#6366f1',
                    didOpen: () => {
                        const slider = document.getElementById('volume-slider');
                        const volumeValue = document.getElementById('volume-value');
                        
                        slider.addEventListener('input', () => {
                            const volume = slider.value / 100;
                            adhanAudio.volume = volume;
                            volumeValue.textContent = `${slider.value}%`;
                        });
                    }
                }).then(() => {
                    // Resume the preview control after volume adjustment
                    if (adhanAudio && !adhanAudio.paused) {
                        previewAdhan(adhanAudio.src);
                    }
                });
            });
            
            // Auto-close after 15 seconds
            setTimeout(() => {
                if (Swal.isVisible()) {
                    Swal.close();
                }
            }, 15000);
        }
    });
    
    // Handle audio end
    adhanAudio.onended = () => {
        if (Swal.isVisible()) {
            Swal.close();
        }
    };
}

// Schedule notification for prayer time
function scheduleNotification(prayer) {
    const settings = notificationSettings[prayer];
    if (!settings) return;
    
    const prayerTime = convertTimeStringToDate(settings.prayerTime);
    if (!prayerTime) return;
    
    // Calculate time for notification
    const now = new Date();
    
    // Generate a unique ID for this notification
    const notificationId = `${prayer}-${prayerTime.getTime()}`;
    
    // Clear any existing scheduled notification for this prayer
    clearScheduledNotification(prayer);
    
    // Check if prayer time is in the future
    if (prayerTime > now) {
        // Schedule notification 10 minutes before if enabled
        if (settings.notifyBefore) {
            const notifyTime = new Date(prayerTime);
            notifyTime.setMinutes(notifyTime.getMinutes() - 10);
            
            if (notifyTime > now) {
                const timeUntilNotify = notifyTime - now;
                const earlyNotificationId = `${prayer}-early-${prayerTime.getTime()}`;
                
                // Store in active notifications
                activeNotifications[earlyNotificationId] = setTimeout(() => {
                    sendPrayerNotification(prayer, true);
                    delete activeNotifications[earlyNotificationId];
                }, timeUntilNotify);
                
                console.log(`Scheduled early notification for ${prayer} in ${Math.floor(timeUntilNotify / 60000)} minutes`);
            }
        }
        
        // Schedule main notification at prayer time
        const timeUntil = prayerTime - now;
        
        // Store in active notifications
        activeNotifications[notificationId] = setTimeout(() => {
            sendPrayerNotification(prayer, false);
            delete activeNotifications[notificationId];
        }, timeUntil);
        
        console.log(`Scheduled notification for ${prayer} in ${Math.floor(timeUntil / 60000)} minutes`);
    }
}

// Clear a scheduled notification
function clearScheduledNotification(prayer) {
    // Find and clear all timeouts related to this prayer
    Object.keys(activeNotifications).forEach(id => {
        if (id.startsWith(`${prayer}-`)) {
            clearTimeout(activeNotifications[id]);
            delete activeNotifications[id];
        }
    });
}

// Send notification for prayer time
async function sendPrayerNotification(prayer, isEarly) {
    const settings = notificationSettings[prayer];
    if (!settings) return;
    
    // Check if browser tab is already focused
    if (document.visibilityState === 'visible') {
        // If we're playing Adhan at prayer time (not early notification), play it even when tab is visible
        if (!isEarly && settings.playAdhan) {
            playAdhan(settings.adhanUrl);
        }
    }
    
    // Display native notification
    const title = isEarly 
        ? `${prayer} Prayer Soon` 
        : `${prayer} Prayer Time`;
    
    const body = isEarly 
        ? `${prayer} prayer will begin in 10 minutes` 
        : `It's time for ${prayer} prayer`;
    
    try {
        // Check if we have service worker or use regular notification
        if (swRegistration && swRegistration.showNotification) {
            // Advanced notification with service worker
            const notificationOptions = {
                body: body,
                icon: APP_FAVICON,
                badge: APP_FAVICON,
                tag: `prayer-${prayer}-${isEarly ? 'early' : 'now'}`,
                renotify: true,
                requireInteraction: !isEarly, // Keep notification for actual prayer time
                actions: [
                    {
                        action: 'open',
                        title: 'Open App'
                    }
                ]
            };
            
            // Add vibration if enabled
            if (settings.vibrateDevice) {
                notificationOptions.vibrate = [200, 100, 200];
            }
            
            await swRegistration.showNotification(title, notificationOptions);
        } else {
            // Regular notification
            const notification = new Notification(title, {
                body: body,
                icon: APP_FAVICON
            });
            
            // Add click handler
            notification.onclick = function() {
                window.focus();
                this.close();
            };
        }
        
        // Play Adhan for the actual prayer time (not early notification)
        if (!isEarly && settings.playAdhan) {
            playAdhan(settings.adhanUrl);
        }
        
        // Vibrate device if enabled
        if (settings.vibrateDevice && "vibrate" in navigator) {
            // Vibration pattern: 200ms vibrate, 100ms pause, 200ms vibrate
            navigator.vibrate([200, 100, 200]);
        }
    } catch (error) {
        console.error('Error sending notification:', error);
    }
}

// Play Adhan
function playAdhan(audioUrl) {
    // Stop any playing audio
    if (adhanAudio) {
        adhanAudio.pause();
        adhanAudio = null;
    }
    
    // Create and play new audio
    adhanAudio = new Audio(audioUrl);
    adhanAudio.volume = 0.7; // Default volume
    
    // Try to resume audio context (needed for mobile)
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    if (audioContext.state === 'suspended') {
        audioContext.resume();
    }
    
    // Play adhan
    adhanAudio.play().catch(error => {
        console.error('Error playing adhan:', error);
        // Show error notification
        if (Notification.permission === 'granted') {
            new Notification('Adhan Error', {
                body: 'Unable to play adhan. Please check your audio settings.',
                icon: APP_FAVICON
            });
        }
    });
    
    // Show controls to stop adhan
    Swal.fire({
        title: 'Adhan Playing',
        html: `
            <div class="text-center">
                <p class="mb-4">Prayer time adhan is playing</p>
                <button id="stop-prayer-adhan" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">
                    <i class="fas fa-stop mr-1"></i> Stop Adhan
                </button>
            </div>
        `,
        showConfirmButton: false,
        showCancelButton: false,
        toast: true,
        position: 'top-end',
        timer: 30000, // Auto close after 30 seconds
        timerProgressBar: true,
        willClose: () => {
            // Don't stop adhan when toast closes unless requested
        },
        didOpen: () => {
            // Add event listener to stop button
            document.getElementById('stop-prayer-adhan').addEventListener('click', () => {
                if (adhanAudio) {
                    adhanAudio.pause();
                    adhanAudio = null;
                }
                Swal.close();
            });
        }
    });
    
    // Handle audio end
    adhanAudio.onended = () => {
        if (Swal.isVisible()) {
            Swal.close();
        }
    };
}

// ======================== LOCATION HANDLING ======================== //

// Get user's location
async function getUserLocation() {
    try {
        updateLoadingState(true, 'Getting location...');
        
        // Check if we already have a stored location
        const storedLocation = localStorage.getItem('userLocation');
        if (storedLocation) {
            const location = JSON.parse(storedLocation);
            currentPosition.latitude = location.latitude;
            currentPosition.longitude = location.longitude;
            updateLocationDisplay(location.address || 'Saved Location');
            
            // Still try to get updated location in background
            navigator.geolocation.getCurrentPosition(
                position => {
                    const { latitude, longitude } = position.coords;
                    
                    // Only update if significantly different (more than ~100m)
                    const distance = calculateDistance(
                        latitude, longitude,
                        currentPosition.latitude, currentPosition.longitude
                    );
                    
                    if (distance > 0.1) {
                        updateUserLocation(position);
                    }
                },
                () => {
                    // Silently fail, we already have a stored location
                }
            );
            
            updateLoadingState(false);
            return true;
        }
        
        // Request new location
        const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            });
        });
        
        updateUserLocation(position);
        updateLoadingState(false);
        return true;
    } catch (error) {
        console.error('Error getting user location:', error);
        updateLoadingState(false);
        
        // Show error using SweetAlert
        Swal.fire({
            title: 'Location Error',
            text: 'Unable to get your location. Please allow location access or enter your location manually.',
            icon: 'error',
            showCancelButton: true,
            confirmButtonColor: '#6366f1',
            cancelButtonColor: '#ef4444',
            confirmButtonText: 'Enter Location',
            cancelButtonText: 'Try Again'
        }).then((result) => {
            if (result.isConfirmed) {
                showManualLocationDialog();
            } else {
                getUserLocation();
            }
        });
        
        return false;
    }
}

// Update user location
async function updateUserLocation(position) {
    const { latitude, longitude } = position.coords;
    currentPosition.latitude = latitude;
    currentPosition.longitude = longitude;
    
    // Attempt to get location name
    try {
        const address = await reverseGeocode(latitude, longitude);
        updateLocationDisplay(address);
        
        // Store location in localStorage
        localStorage.setItem('userLocation', JSON.stringify({
            latitude,
            longitude,
            address,
            timestamp: new Date().getTime()
        }));
    } catch (error) {
        console.error('Error getting location address:', error);
        updateLocationDisplay(`${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
        
        // Store location without address
        localStorage.setItem('userLocation', JSON.stringify({
            latitude,
            longitude,
            timestamp: new Date().getTime()
        }));
    }
    
    return { latitude, longitude };
}

// Show manual location input dialog
function showManualLocationDialog() {
    Swal.fire({
        title: 'Enter Your Location',
        html: `
            <input id="manual-location" class="swal2-input" placeholder="City, Country (e.g., Cairo, Egypt)">
            <p class="text-sm text-gray-500 mt-2">Or enter coordinates:</p>
            <div class="flex space-x-2 mt-2">
                <input id="manual-lat" class="swal2-input" placeholder="Latitude (e.g., 30.0444)">
                <input id="manual-lng" class="swal2-input" placeholder="Longitude (e.g., 31.2357)">
            </div>
        `,
        showCancelButton: true,
        confirmButtonText: 'Search',
        confirmButtonColor: '#6366f1',
        preConfirm: () => {
            const location = document.getElementById('manual-location').value;
            const lat = document.getElementById('manual-lat').value;
            const lng = document.getElementById('manual-lng').value;
            
            if (location) {
                return { location };
            } else if (lat && lng) {
                return { lat, lng };
            } else {
                Swal.showValidationMessage('Please enter a location or coordinates');
                return false;
            }
        }
    }).then((result) => {
        if (result.isConfirmed) {
            if (result.value.location) {
                geocodeLocation(result.value.location);
            } else if (result.value.lat && result.value.lng) {
                const lat = parseFloat(result.value.lat);
                const lng = parseFloat(result.value.lng);
                
                if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                    Swal.fire({
                        title: 'Invalid Coordinates',
                        text: 'Please enter valid latitude (-90 to 90) and longitude (-180 to 180)',
                        icon: 'error',
                        confirmButtonText: 'Try Again',
                        confirmButtonColor: '#6366f1'
                    }).then(() => {
                        showManualLocationDialog();
                    });
                } else {
                    currentPosition.latitude = lat;
                    currentPosition.longitude = lng;
                    updateLocationDisplay(`${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                    
                    // Store location
                    localStorage.setItem('userLocation', JSON.stringify({
                        latitude: lat,
                        longitude: lng,
                        timestamp: new Date().getTime()
                    }));
                    
                    refreshPrayerTimes();
                }
            }
        }
    });
}

// Geocode location (convert place name to coordinates)
async function geocodeLocation(locationName) {
    try {
        updateLoadingState(true, 'Finding location...');
        
        // Use Nominatim API (OpenStreetMap) for geocoding
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}`;
        
        const response = await fetch(url, {
            headers: {
                'Accept-Language': 'en',
                'User-Agent': 'PrayerTimesApp/1.0'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Geocoding failed: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.length === 0) {
            throw new Error('Location not found');
        }
        
        // Get first result
        const result = data[0];
        currentPosition.latitude = parseFloat(result.lat);
        currentPosition.longitude = parseFloat(result.lon);
        
        // Create display name
        const display = result.display_name.split(',').slice(0, 2).join(', ');
        updateLocationDisplay(display);
        
        // Store location
        localStorage.setItem('userLocation', JSON.stringify({
            latitude: currentPosition.latitude,
            longitude: currentPosition.longitude,
            address: display,
            timestamp: new Date().getTime()
        }));
        
        updateLoadingState(false);
        refreshPrayerTimes();
        
        return { lat: currentPosition.latitude, lng: currentPosition.longitude };
    } catch (error) {
        console.error('Error geocoding location:', error);
        updateLoadingState(false);
        
        Swal.fire({
            title: 'Location Not Found',
            text: 'Could not find the location. Please try a different search term or enter coordinates.',
            icon: 'error',
            confirmButtonText: 'Try Again',
            confirmButtonColor: '#6366f1'
        }).then(() => {
            showManualLocationDialog();
        });
        
        return null;
    }
}

// Reverse geocode coordinates to address
async function reverseGeocode(latitude, longitude) {
    try {
        // Use Nominatim API (OpenStreetMap) for reverse geocoding
        const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`;
        
        const response = await fetch(url, {
            headers: {
                'Accept-Language': 'en',
                'User-Agent': 'PrayerTimesApp/1.0'
            }
        });
        
        if (!response.ok) {
            throw new Error(`Reverse geocoding failed: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Extract city and country or return a simplified address
        let address;
        if (data.address) {
            const { city, town, village, county, state, country } = data.address;
            const locality = city || town || village || county || state || '';
            address = locality && country ? `${locality}, ${country}` : data.display_name.split(',').slice(0, 2).join(', ');
        } else {
            address = data.display_name.split(',').slice(0, 2).join(', ');
        }
        
        return address;
    } catch (error) {
        console.error('Error reverse geocoding:', error);
        throw error;
    }
}

// Calculate distance between two coordinates (haversine formula)
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Radius of the Earth in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
        Math.sin(dLon/2) * Math.sin(dLon/2);
    
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    const distance = R * c; // Distance in km
    
    return distance;
}

// Update location display in UI
function updateLocationDisplay(locationName) {
    const locationElement = safeGetElement('location-display', 'div');
    if (locationElement) {
        locationElement.innerHTML = `
            <i class="fas fa-map-marker-alt text-indigo-500 mr-1"></i>
            ${locationName}
        `;
    }
}
        function updatePrayerTimesLink(location) {
    let prayerTimesLink = `https://www.google.com/search?q=Prayer-times+${encodeURIComponent(location)}`;
    document.getElementById("prayer-times-link").innerHTML = 
        `<a href="${prayerTimesLink}" target="_blank">Prayer Times in ${location}</a>`;
}


// ======================== UTILITY FUNCTIONS ======================== //

// Update loading state
function updateLoadingState(isLoading, message = 'Loading...') {
    const loaderElement = safeGetElement('loader', 'div');
    
    if (!loaderElement) {
        console.error('Loader element not found and could not be created');
        return;
    }
    
    if (isLoading) {
        loaderElement.innerHTML = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white p-6 rounded-lg shadow-xl flex flex-col items-center">
                    <div class="loader"></div>
                    <p class="mt-4 text-lg font-medium">${message}</p>
                </div>
            </div>
        `;
        loaderElement.style.display = 'block';
    } else {
        loaderElement.style.display = 'none';
    }
}

// Load settings from localStorage
function loadSettings() {
    try {
        // Load notification settings
        const savedNotifications = localStorage.getItem('prayerNotifications');
        if (savedNotifications) {
            notificationSettings = JSON.parse(savedNotifications);
        }
        
        // Load other app settings if needed
        // ...
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// Refresh prayer times
async function refreshPrayerTimes() {
    if (!currentPosition.latitude || !currentPosition.longitude) {
        const locationObtained = await getUserLocation();
        if (!locationObtained) return;
    }
    
    const today = new Date();
    const prayerTimes = await fetchPrayerTimes(
        currentPosition.latitude,
        currentPosition.longitude,
        today
    );
    
    displayPrayerTimes(prayerTimes);
    
    // Reschedule notifications
    Object.keys(notificationSettings).forEach(prayer => {
        notificationSettings[prayer].prayerTime = prayerTimes[prayer];
        scheduleNotification(prayer);
    });
}

// ======================== INITIALIZATION ======================== //

// Initialize the app
async function initApp() {
    // Load saved settings
    loadSettings();
    
    // Check notification permission status
    if (checkNotificationSupport() && Notification.permission === 'granted') {
        registerServiceWorker();
    }
    
    // Get user location and display prayer times
    const locationObtained = await getUserLocation();
    
    if (locationObtained) {
        const today = new Date();
        const prayerTimes = await fetchPrayerTimes(
            currentPosition.latitude,
            currentPosition.longitude,
            today
        );
        
        displayPrayerTimes(prayerTimes);
    }
    
    // Add event listeners for UI controls
    safeGetElement('change-location-btn', 'button')?.addEventListener('click', () => {
        showManualLocationDialog();
    });
    
    safeGetElement('refresh-btn', 'button')?.addEventListener('click', () => {
        refreshPrayerTimes();
    });
    
    // Setup periodic refresh (every 5 minutes)
    setInterval(() => {
        refreshPrayerTimes();
    }, 5 * 60 * 1000);
}
        fetch(apiUrl)
    .then(response => response.json())
    .then(data => {
        let city = data.address.city || data.address.town || data.address.village || "";
        let country = data.address.country || "";
        
        if (city) {
            updatePrayerTimesLink(city);
        } else if (country) {
            updatePrayerTimesLink(country);
        }
    })
    .catch(error => console.log("Error fetching location data:", error));


// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', initApp);

// Re-initialize when document becomes visible (tab focus)
document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        refreshPrayerTimes();
    }
});
    </script>
</body>
</html>
